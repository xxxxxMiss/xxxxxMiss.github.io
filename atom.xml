<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>青史成灰</title>
  
  <subtitle>Every journey begins with the first step</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://xxxxxmiss.github.io/"/>
  <updated>2019-04-02T14:37:34.337Z</updated>
  <id>https://xxxxxmiss.github.io/</id>
  
  <author>
    <name>xxxxxMiss</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>xxxxxmiss-resume</title>
    <link href="https://xxxxxmiss.github.io/2019/04/02/xxxxxmiss-resume/"/>
    <id>https://xxxxxmiss.github.io/2019/04/02/xxxxxmiss-resume/</id>
    <published>2019-04-02T08:04:26.000Z</published>
    <updated>2019-04-02T14:37:34.337Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul><li>陈先龙</li><li>男|未婚|1991 年 5 月生</li><li>户口：安徽-安庆，现居住于：上海</li><li>4 年多工作经验</li><li>Tel：18255820533</li><li>E-mail：xxxxxmiss@gmail.com | 794465731@qq.com</li></ul><h2 id="求职意向"><a href="#求职意向" class="headerlink" title="求职意向"></a>求职意向</h2><ul><li>工作性质：全职</li><li>期望职业：WEB 前端开发、(可接受 Nodejs 开发）</li><li>期望行业：计算机软件</li><li>工作地区：上海</li></ul><h2 id="工作经历"><a href="#工作经历" class="headerlink" title="工作经历"></a>工作经历</h2><blockquote><p>2017.04 – 2019.04</p></blockquote><p>义橙网络科技(上海)有限公司</p><h3 id="EDM邮件后台（2017-07-2017-09）"><a href="#EDM邮件后台（2017-07-2017-09）" class="headerlink" title="EDM邮件后台（2017.07-2017.09）"></a>EDM邮件后台（2017.07-2017.09）</h3><h5 id="责任描述"><a href="#责任描述" class="headerlink" title="责任描述"></a>责任描述</h5><p>负责项目的搭建，功能的开发，测试，上线</p><h5 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h5><p>EDM邮件后台是一个内部的发邮件项目，主要用来帮助e成以及e成合作的客户发送职位推荐邮件。发送人员可配置公司相关的东西，如公司logo，公司综合实力，公司介绍等；可配置与职位相关的东西，如职位介绍，职位要求等。可统计发送的邮件在各个时间端内被查看的次数等，可统计邮件发送的进度等等。</p><h5 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h5><p>Vue + vue-router + vuex + axios + elementui + echarts + stylus</p><h3 id="内推伯乐移动端项目（2017-11-2018-02）"><a href="#内推伯乐移动端项目（2017-11-2018-02）" class="headerlink" title="内推伯乐移动端项目（2017.11-2018.02）"></a>内推伯乐移动端项目（2017.11-2018.02）</h3><h5 id="责任描述-1"><a href="#责任描述-1" class="headerlink" title="责任描述"></a>责任描述</h5><p>负责整个项目的搭建，基础组件的开发，开发任务的分配，整个项目的把控及上线。</p><h5 id="项目简介-1"><a href="#项目简介-1" class="headerlink" title="项目简介"></a>项目简介</h5><p>内推伯乐移动端项目是一个帮助公司内推人才的项目。用户首先注册成为某一个公司的伯乐，然后通过该平台来内推你认识小伙伴给公司。也可以通过分享相关职位给你认识的小伙伴，朋友圈等，然后小伙伴可以通过你分享的链接进行相关职位的投递。</p><h5 id="技术栈（vue-ssr）"><a href="#技术栈（vue-ssr）" class="headerlink" title="技术栈（vue ssr）"></a>技术栈（vue ssr）</h5><p>nuxtjs + axios + 自己开发的vue组件库 + stylus</p><h3 id="内推伯乐移动端项目重构（2018-05-2018-06）"><a href="#内推伯乐移动端项目重构（2018-05-2018-06）" class="headerlink" title="内推伯乐移动端项目重构（2018.05-2018.06）"></a>内推伯乐移动端项目重构（2018.05-2018.06）</h3><h5 id="责任描述-2"><a href="#责任描述-2" class="headerlink" title="责任描述"></a>责任描述</h5><p>将整个项目迁移到客户端渲染</p><h5 id="技术栈-1"><a href="#技术栈-1" class="headerlink" title="技术栈"></a>技术栈</h5><p>eggjs + vue + vue-router + vuex + axios + 自己开发的vue组件库 + stylus</p><h3 id="内推伯乐pc端（2018-06-2018-08）"><a href="#内推伯乐pc端（2018-06-2018-08）" class="headerlink" title="内推伯乐pc端（2018.06-2018.08）"></a>内推伯乐pc端（2018.06-2018.08）</h3><h5 id="责任描述-3"><a href="#责任描述-3" class="headerlink" title="责任描述"></a>责任描述</h5><p>负责项目的搭建，简历模块的开发</p><h5 id="项目简介-2"><a href="#项目简介-2" class="headerlink" title="项目简介"></a>项目简介</h5><p>同伯乐移动端，不过是pc端的实现</p><h5 id="技术栈-2"><a href="#技术栈-2" class="headerlink" title="技术栈"></a>技术栈</h5><p>react + antd + axios + scss</p><h3 id="内推伯乐小程序（2018-08-2018-09）"><a href="#内推伯乐小程序（2018-08-2018-09）" class="headerlink" title="内推伯乐小程序（2018.08-2018.09）"></a>内推伯乐小程序（2018.08-2018.09）</h3><h5 id="责任描述-4"><a href="#责任描述-4" class="headerlink" title="责任描述"></a>责任描述</h5><p>负责项目的搭建，个人中心，候选人模块的开发</p><h5 id="项目简介-3"><a href="#项目简介-3" class="headerlink" title="项目简介"></a>项目简介</h5><p>同伯乐移动端，不过是微信小程序的实现</p><h5 id="技术栈-3"><a href="#技术栈-3" class="headerlink" title="技术栈"></a>技术栈</h5><p>微信原生框架</p><h3 id="新C端官网（2018-11-2019-01）"><a href="#新C端官网（2018-11-2019-01）" class="headerlink" title="新C端官网（2018.11-2019.01）"></a>新C端官网（2018.11-2019.01）</h3><h5 id="责任描述-5"><a href="#责任描述-5" class="headerlink" title="责任描述"></a>责任描述</h5><p>负责新技术的调研，搭建</p><h5 id="技术栈-4"><a href="#技术栈-4" class="headerlink" title="技术栈"></a>技术栈</h5><p>eggjs + nujunks + webpack + scss + axios</p><h3 id="职位咨询bot（2019-01-2019-03）"><a href="#职位咨询bot（2019-01-2019-03）" class="headerlink" title="职位咨询bot（2019.01-2019.03）"></a>职位咨询bot（2019.01-2019.03）</h3><h5 id="责任描述-6"><a href="#责任描述-6" class="headerlink" title="责任描述"></a>责任描述</h5><p>负责某些功能的优化，bug修复</p><h5 id="项目简介-4"><a href="#项目简介-4" class="headerlink" title="项目简介"></a>项目简介</h5><p>职位咨询bot是一款帮助候选人通过和机器人对话的形式快速了解一个企业的文化背景，相关职位信息等。</p><h5 id="技术栈-5"><a href="#技术栈-5" class="headerlink" title="技术栈"></a>技术栈</h5><p>微信原生框架</p><h3 id="ATS项目支援（2019-03-至今）"><a href="#ATS项目支援（2019-03-至今）" class="headerlink" title="ATS项目支援（2019.03-至今）"></a>ATS项目支援（2019.03-至今）</h3><h5 id="责任描述-7"><a href="#责任描述-7" class="headerlink" title="责任描述"></a>责任描述</h5><p>支持tob的ATS相关功能的开发</p><h5 id="技术栈-6"><a href="#技术栈-6" class="headerlink" title="技术栈"></a>技术栈</h5><p>react + mobx + react-mobx + scss</p><p>react + redux + redux-saga + scss</p><blockquote><p>2016.10 – 2017.04</p></blockquote><p>上海晓家网络科技有限公司前端开发</p><h5 id="责任描述-8"><a href="#责任描述-8" class="headerlink" title="责任描述"></a>责任描述</h5><ul><li>网站端模块：迭代开发与优化首页以及聊天等相关功能</li><li>移动端：发布需求功能的开发以及各个模块功能的维护与优化</li></ul><h5 id="项目简介-5"><a href="#项目简介-5" class="headerlink" title="项目简介"></a>项目简介</h5><p>「大牛家」是一个为企业对接行业专家的咨询服务平台，大牛家通过汇聚各行业、各领域有资深实战经验的专业人士到大牛家平台，打破专家资源壁垒，建立高效连接，实现无论什么行业与职能，都可以来大牛家总可以找到资深专家进行访谈和咨询。<br>「大牛家」建立了网站，移动，微信公众号等多渠道平台，可以企业更加方便的寻找专家。<br>后台使用 php，聊天服务使用 nodejs。</p><h5 id="技术栈-7"><a href="#技术栈-7" class="headerlink" title="技术栈"></a>技术栈</h5><ul><li>网站端：twing, react+redux+react-redux，scss, jquey，gulp, webpack1.x 以及相关第三方库</li><li>移动端: vue1.0.26 + vuex + vue-router+vue-resource, scss, webapck1.x 以及相关第三方库</li></ul><blockquote><p>2017.04 - 2017.04</p></blockquote><h3 id="vue2-cnode-社区（个人项目）"><a href="#vue2-cnode-社区（个人项目）" class="headerlink" title="vue2-cnode 社区（个人项目）"></a>vue2-cnode 社区（个人项目）</h3><h5 id="责任描述-9"><a href="#责任描述-9" class="headerlink" title="责任描述"></a>责任描述</h5><p>从项目的架构，到项目的发布。使用 cnode 社区提供的 API，做了一个 cnode 社区的 webapp。</p><h5 id="项目简介-6"><a href="#项目简介-6" class="headerlink" title="项目简介"></a>项目简介</h5><p><a href="https://cnodejs.org/" target="_blank" rel="noopener">CNode</a>是 Nodejs 中文社区，提供了发帖，评论，招聘等功能。给广大的 nodejs 开发者提供了一个交流，共享技术的平台，同时给 HR 们提供了一个招聘的平台。</p><h5 id="技术栈-8"><a href="#技术栈-8" class="headerlink" title="技术栈"></a>技术栈</h5><p>vue2+vuex+vue-router+superagent+stylus+pug+webpack2.x</p><ul><li>预览地址：<a href="https://xxxxxmiss.github.io/vue2-cnode/#/index">https://xxxxxmiss.github.io/vue2-cnode/#/index</a></li><li>源码地址：<a href="https://github.com/xxxxxMiss/vue2-element-cnode" target="_blank" rel="noopener">https://github.com/xxxxxMiss/vue2-element-cnode</a></li></ul><blockquote><p>2016.02 – 2016.10</p></blockquote><p>上海艾融软件前端开发</p><ul><li>行业类别： 计算机软件</li><li>企业性质：上市公司</li><li>规模：500-999 人</li></ul><h3 id="手机银行积分乐园"><a href="#手机银行积分乐园" class="headerlink" title="手机银行积分乐园"></a>手机银行积分乐园</h3><h5 id="责任描述-10"><a href="#责任描述-10" class="headerlink" title="责任描述"></a>责任描述</h5><p>开发<code>嗨购</code>，<code>里程兑换</code>，<code>保险</code>，<code>水电费</code>等模块。</p><h5 id="项目简介-7"><a href="#项目简介-7" class="headerlink" title="项目简介"></a>项目简介</h5><p>该项目是一个类似于积分商城的业务，提供了很多便民服务如<code>水电费</code>，<code>保险</code>，<code>购物</code>等功能，所有的这些操作都可以产生相应的积分，这些积分可以用在相关的消费业务中抵扣一定的金额。</p><h3 id="手机银行-o2o-新平台电影院"><a href="#手机银行-o2o-新平台电影院" class="headerlink" title="手机银行 o2o 新平台电影院"></a>手机银行 o2o 新平台电影院</h3><h5 id="责任描述-11"><a href="#责任描述-11" class="headerlink" title="责任描述"></a>责任描述</h5><p>负责整个电影院前端的开发：从零开始搭建开发环境，到电影院列表，影片列表，订单列表等列表组件的封装，到相关接口的调试等。</p><h4 id="项目简介-8"><a href="#项目简介-8" class="headerlink" title="项目简介"></a>项目简介</h4><p>该项目是手机银行 APP 中的一个子模块，提供了购买电影票的功能。</p><h5 id="技术栈-9"><a href="#技术栈-9" class="headerlink" title="技术栈"></a>技术栈</h5><p>zepto, iscroll, scss, juicer 模板, gulp</p><blockquote><p>2014.02 – 2015.12</p></blockquote><p>上海屹通信息科技发展有限公司|软件工程师</p><ul><li>行业类别： 计算机软件</li><li>企业性质：上市公司</li><li>规模：500-999 人</li></ul><h5 id="责任描述-12"><a href="#责任描述-12" class="headerlink" title="责任描述"></a>责任描述</h5><p>从事手机银行项目的开发，呆过四川省农村信用社，河北承德银行，成都银行等项目组。在各个项目组，主要负责转账，红包，储蓄理财等核心模块的开发，以及整体样式的把控和框架的维护。</p><h5 id="项目简介-9"><a href="#项目简介-9" class="headerlink" title="项目简介"></a>项目简介</h5><p><code>四川省农村信用社</code>、<code>河北承德银行</code>、<code>成都银行</code>等手机银行提供了转账，理财，账单查询等相关服务，主要是为了帮助广大消费者快速，安全，高效的进行金钱相关的操作。项目采用混合式开发，前端开发好的页面作为原生 APP 的静态资源，打包压缩到客户端的资源目录。</p><h5 id="技术栈-10"><a href="#技术栈-10" class="headerlink" title="技术栈"></a>技术栈</h5><p>jquery、echarts、公司自己封装的 YT 框架。</p><blockquote><p>2014.10 – 2015.12</p></blockquote><h3 id="四川省农村信用社移动门户-hybrid-开发"><a href="#四川省农村信用社移动门户-hybrid-开发" class="headerlink" title="四川省农村信用社移动门户 hybrid 开发"></a>四川省农村信用社移动门户 hybrid 开发</h3><ul><li>软件环境：jdk1.7,oracle</li><li>硬件环境：windows8</li><li>开发工具：eclipse，axure，markman，xshell</li></ul><h5 id="责任描述-13"><a href="#责任描述-13" class="headerlink" title="责任描述"></a>责任描述</h5><p>负责转账，随意转，AA 收付款等相关模块业务需求的编写，UED 的开发，软需的编写和评审以及代码的编写；和其他关联系统接口的联调；帮助项目组其他开发成员解决相关问题和框架的维护。</p><h5 id="项目简介-10"><a href="#项目简介-10" class="headerlink" title="项目简介"></a>项目简介</h5><p>四川省农村信用社，该项目由多个关联系统组成，如移动门户，门户，交互平台，能力中心，核心等关联系统组成，上海屹通有限公司主要负责移动门户这个系统。</p><h5 id="技术栈-11"><a href="#技术栈-11" class="headerlink" title="技术栈"></a>技术栈</h5><p>jquery、echarts、iswiper、公司自己封装的 YT 框架。</p><blockquote><p>2014.02 —- 2014.08</p></blockquote><h3 id="河北承德银行-java-开发"><a href="#河北承德银行-java-开发" class="headerlink" title="河北承德银行 java 开发"></a>河北承德银行 java 开发</h3><ul><li>软件环境：jdk1.7,oracle</li><li>硬件环境：windows8</li><li>开发工具：eclipse，axure，markman，xshell</li></ul><h5 id="责任描述-14"><a href="#责任描述-14" class="headerlink" title="责任描述"></a>责任描述</h5><p>主要负责红包，储蓄理财后台 java 代码的编写和行方接口的联调以及相关功能的测试。</p><h5 id="技术栈-12"><a href="#技术栈-12" class="headerlink" title="技术栈"></a>技术栈</h5><p>Spring、Mybatis、Oracle、公司自己封装的一套 Java 框架。</p><h2 id="个人技术栈"><a href="#个人技术栈" class="headerlink" title="个人技术栈"></a>个人技术栈</h2><ul><li>JS: ES2015，Nodejs</li><li>JS 模板: pug(jade)， juicer， nujunks， twig 等</li><li>JS 插件/类库：swiper，iscroll，zepto，jquery，lodash 等</li><li>前端UI框架/组件：mui, FrozenUI，elementui, antd 等</li><li>前端 MVVM 框架: vue，React，了解 react-native, weex 等</li><li>小程序：微信原生，mpvue等</li><li>css 相关：常用 sass，stylus，less 等</li><li>构建工具：gulp，webpack，rollup 等</li><li>后端语言：java(14 年做过半年的 java 开发), nodejs</li><li>版本控制工具：SVN，git 版本控制工具的使用</li><li>linux： 熟悉常用 linux 命令，编写基本的shell脚本</li></ul><h2 id="教育经历"><a href="#教育经历" class="headerlink" title="教育经历"></a>教育经历</h2><blockquote><p>2010.09 – 2014.06</p></blockquote><p>阜阳师范学院|计算机科学与技术|本科|统招<br>证书</p><blockquote><p>2013.09</p></blockquote><p>大学英语四级</p><blockquote><p>2014.06</p></blockquote><p>全国计算机等级四级<br>语言能力<br>英语：读写能力一般， 听说能力一般，阅读一般的英文 API 无障碍。</p><h2 id="兴趣爱好"><a href="#兴趣爱好" class="headerlink" title="兴趣爱好"></a>兴趣爱好</h2><p>旅游，书法，学习新技术，逛逛博客，逛逛 github，写写博客，打打 DOTA2。喜欢学习新的技术，学习源代码，知其然，更要知其所以然；对代码有洁癖。</p><ul><li>github 地址：<a href="https://github.com/xxxxxMiss" target="_blank" rel="noopener">https://github.com/xxxxxMiss</a></li><li>博客地址：<a href="https://xxxxxmiss.github.io/(最近新搭建的hexo，以前使用的csdn">https://xxxxxmiss.github.io/(最近新搭建的hexo，以前使用的csdn</a>)</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;陈先龙&lt;/li&gt;
&lt;li&gt;男|未婚|1991 年 5 月生&lt;/li&gt;
&lt;li&gt;户口：安徽-安庆，现居住于：上海&lt;/li&gt;
&lt;li
      
    
    </summary>
    
      <category term="生活" scheme="https://xxxxxmiss.github.io/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="简历" scheme="https://xxxxxmiss.github.io/tags/%E7%AE%80%E5%8E%86/"/>
    
      <category term="求职" scheme="https://xxxxxmiss.github.io/tags/%E6%B1%82%E8%81%8C/"/>
    
  </entry>
  
  <entry>
    <title>git进阶（三）</title>
    <link href="https://xxxxxmiss.github.io/2019/01/22/git-plumbing-3/"/>
    <id>https://xxxxxmiss.github.io/2019/01/22/git-plumbing-3/</id>
    <published>2019-01-22T03:12:22.000Z</published>
    <updated>2019-01-22T14:09:01.394Z</updated>
    
    <content type="html"><![CDATA[<h1 id="git-reset"><a href="#git-reset" class="headerlink" title="git reset"></a>git reset</h1><h2 id="git-rest-mode-commit"><a href="#git-rest-mode-commit" class="headerlink" title="git rest [mode][commit]"></a>git rest [mode][commit]</h2><h3 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode</h3><ul><li>–soft：<code>.git/HEAD</code>中的引用不会改变，但是引用的值会发生改变。</li></ul><blockquote><p>比如开始<code>.git/HEAD</code>指向了<code>.git/ref/heads/master</code>中的值为<code>2a0570f44e82017823a19d08fc4cb342584dd05c</code>（最后一次提交的 sha-1），经过<code>git reset --soft HEAD^</code>，那么<code>.git/ref/heads/master</code>中的值会变为<code>978fc8a9dc1d920afda948380fa2dd339d5d9050</code>（倒数第二次的 sha-1）。就是说没做一次这样的操作<code>git reset --soft HEAD^</code>，<code>.git/ref/heads/master</code>中的指针就向前移动一次（正常情况下指针指向最后一次提交记录）。</p></blockquote><ul><li><p>–mixed：</p></li><li><p>–hard：</p></li><li><p>–merge：</p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;git-reset&quot;&gt;&lt;a href=&quot;#git-reset&quot; class=&quot;headerlink&quot; title=&quot;git reset&quot;&gt;&lt;/a&gt;git reset&lt;/h1&gt;&lt;h2 id=&quot;git-rest-mode-commit&quot;&gt;&lt;a href=&quot;#git-r
      
    
    </summary>
    
      <category term="git" scheme="https://xxxxxmiss.github.io/categories/git/"/>
    
    
      <category term="workflow" scheme="https://xxxxxmiss.github.io/tags/workflow/"/>
    
      <category term="git" scheme="https://xxxxxmiss.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>webpack-data</title>
    <link href="https://xxxxxmiss.github.io/2019/01/09/webpack-data/"/>
    <id>https://xxxxxmiss.github.io/2019/01/09/webpack-data/</id>
    <published>2019-01-09T08:03:44.000Z</published>
    <updated>2019-01-18T02:49:54.653Z</updated>
    
    <content type="html"><![CDATA[<h2 id="compilation"><a href="#compilation" class="headerlink" title="compilation"></a>compilation</h2><blockquote><p>实例方法：</p></blockquote><ul><li><p>getStats()</p></li><li><p>addModule(module, cacheGroup)</p></li><li><p>getModule(module)</p></li><li><p>findModule(identifier)</p></li><li><p>waitForBuildingFinished(module, callback)</p></li><li><p>buildModule(module, optional, origin, dependencies, thisCallback)</p></li><li><p>processModuleDependencies(module, callback)</p></li><li><p>addModuleDependencies(<br>module,<br>dependencies,<br>bail,<br>cacheGroup,<br>recursive,<br>callback<br>)</p></li><li><p>addEntry(context, entry, name, callback)</p></li><li><p>prefetch(context, dependency, callback)</p></li><li><p>rebuildModule(module, thisCallback)</p></li><li><p>finish()</p></li><li><p>unseal()</p></li><li><p>seal(callback)</p></li><li><p>reportDependencyErrorsAndWarnings(module, blocks)</p></li><li><p>addChunkInGroup(groupOptions, module, loc, request)</p></li><li><p>addChunk(name)</p></li><li><p>assignDepth(module)</p></li><li><p>getDependencyReference(module, dependency)</p></li><li><p>processDependenciesBlocksForChunkGroups(inputChunkGroups)</p></li><li><p>removeReasonsOfDependencyBlock(module, block)</p></li><li><p>patchChunksAfterReasonRemoval(module, chunk)</p></li><li><p>removeChunkFromDependencies(block, chunk)</p></li><li><p>applyModuleIds()</p></li><li><p>applyChunkIds()</p></li><li><p>sortItemsWithModuleIds()</p></li><li><p>sortItemsWithChunkIds()</p></li><li><p>summarizeDependencies()</p></li><li><p>createHash()</p></li><li><p>modifyHash(update)</p></li><li><p>createModuleAssets()</p></li><li><p>createChunkAssets()</p></li><li><p>getPath(filename, data)</p></li><li><p>createChildCompiler(name, outputOptions, plugins)</p></li><li><p>checkConstraints()</p></li></ul><h2 id="compilation-assets"><a href="#compilation-assets" class="headerlink" title="compilation.assets"></a>compilation.assets</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">'account/index.html'</span>: CachedSource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/webpack/webpack-sources" target="_blank" rel="noopener">CachedSource</a></p><h2 id="chunk"><a href="#chunk" class="headerlink" title="chunk"></a>chunk</h2><ul><li><p>canBeInitial()</p><blockquote><p>是否初始化加载（对应的是按需加载）</p></blockquote></li><li><p>files</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;[<span class="string">'account/index.html'</span>]</span><br></pre></td></tr></table></figure><h2 id="compilation-hooks"><a href="#compilation-hooks" class="headerlink" title="compilation hooks"></a>compilation hooks</h2><ul><li>optimizeChunkAssets</li></ul><blockquote><p>args: chunks</p></blockquote><h2 id="compiler"><a href="#compiler" class="headerlink" title="compiler"></a>compiler</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compiler.inputFileSystem = &#123;</span><br><span class="line">  purge() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">compiler.purgeInputFileSystem()</span><br></pre></td></tr></table></figure><ul><li>comipler.watchMode<blockquote><p>是否处于 watch 模式</p></blockquote></li></ul><h2 id="compiler-hooks"><a href="#compiler-hooks" class="headerlink" title="compiler hooks"></a>compiler hooks</h2><ul><li>beforeCompile</li></ul><blockquote><p>args: params</p></blockquote><ul><li>compile</li></ul><blockquote><p>args: params</p></blockquote><h3 id="params"><a href="#params" class="headerlink" title="params"></a>params</h3><blockquote><p>params 对象上有如下东西：</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> params = &#123;</span><br><span class="line">  <span class="comment">// createNormalModuleFactory()触发normalModuleFactory钩子</span></span><br><span class="line">  <span class="comment">// this.hooks.normalModuleFactory.call(normalModuleFactory);</span></span><br><span class="line">  normalModuleFactory: <span class="keyword">this</span>.createNormalModuleFactory(),</span><br><span class="line">  <span class="comment">// createContextModuleFactory()触发contextModuleFactory钩子</span></span><br><span class="line">  <span class="comment">//this.hooks.contextModuleFactory.call(contextModuleFactory);</span></span><br><span class="line">  contextModuleFactory: <span class="keyword">this</span>.createContextModuleFactory(),</span><br><span class="line">  compilationDependencies: <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="normalModuleFactory"><a href="#normalModuleFactory" class="headerlink" title="normalModuleFactory"></a>normalModuleFactory</h3><blockquote><p>该对象是一个<code>NormalModuleFactory</code>类的实例</p></blockquote><h3 id="NormalModuleFactory"><a href="#NormalModuleFactory" class="headerlink" title="NormalModuleFactory"></a>NormalModuleFactory</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NormalModuleFactory</span> <span class="keyword">extends</span> <span class="title">Tapable</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><blockquote><p>实例方法：</p></blockquote><ul><li><p>create(data, callback)</p></li><li><p>resolveRequestArray(contextInfo, context, array, resolver, callback)</p></li><li><p>getParser(type, parserOptions)</p></li><li><p>createParser(type, parserOptions = {})</p></li><li><p>getGenerator(type, generatorOptions)</p></li><li><p>createGenerator(type, generatorOptions = {})</p></li><li><p>getResolver(type, resolveOptions)</p></li></ul><h3 id="ContextModuleFactory"><a href="#ContextModuleFactory" class="headerlink" title="ContextModuleFactory"></a>ContextModuleFactory</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextModuleFactory</span> <span class="keyword">extends</span> <span class="title">Tapable</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><blockquote><p>实例方法：</p></blockquote><ul><li><p>create(data, callback)</p></li><li><p>resolveDependencies(fs, options, callback)</p></li></ul><h2 id="模块基类之间的继承关系"><a href="#模块基类之间的继承关系" class="headerlink" title="模块基类之间的继承关系"></a>模块基类之间的继承关系</h2><h3 id="DependenciesBlock"><a href="#DependenciesBlock" class="headerlink" title="DependenciesBlock"></a>DependenciesBlock</h3><blockquote><p>实例属性</p></blockquote><ul><li><p>dependencies: []</p></li><li><p>blocks: []</p></li><li><p>variables: []</p></li></ul><blockquote><p>实例方法</p></blockquote><ul><li><p>addBlock(block)</p><blockquote><p>用来做代码分割的</p></blockquote></li><li><p>addVariable(name, expression, dependencies)</p></li><li><p>addDependency(dependency)</p></li><li><p>removeDependency(dependency)</p></li><li><p>updateHash(hash)</p></li><li><p>disconnect()</p></li><li><p>unseal()</p></li><li><p>hasDependencies(filter)</p></li><li><p>sortItems()</p></li></ul><h3 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Module</span> <span class="keyword">extends</span> <span class="title">DependenciesBlock</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><blockquote><p>实例属性</p></blockquote><ul><li><p>this.type = type;</p></li><li><p>this.context = context;</p></li><li><p>this.debugId = debugId++;</p></li><li><p>this.hash = undefined;</p></li><li><p>this.renderedHash = undefined;</p></li><li><p>this.resolveOptions = EMPTY_RESOLVE_OPTIONS;</p></li><li><p>this.factoryMeta = {};</p></li><li><p>this.warnings = [];</p></li><li><p>this.errors = [];</p></li><li><p>this.buildMeta = undefined;</p></li><li><p>this.buildInfo = undefined;</p></li><li><p>this.reasons = [];</p></li><li><p>this._chunks = new SortableSet(undefined, sortById);</p></li><li><p>this.id = null;</p></li><li><p>this.index = null;</p></li><li><p>this.index2 = null;</p></li><li><p>this.depth = null;</p></li><li><p>this.issuer = null;</p></li><li><p>this.profile = undefined;</p></li><li><p>this.prefetched = false;</p></li><li><p>this.built = false;</p></li><li><p>this.used = null;</p></li><li><p>this.usedExports = null;</p></li><li><p>this.optimizationBailout = [];</p></li><li><p>this._rewriteChunkInReasons = undefined;</p></li><li><p>this.useSourceMap = false;</p></li><li><p>this._source = null;</p></li></ul><blockquote><p>getter</p></blockquote><ul><li><p>get exportsArgument()</p></li><li><p>get moduleArgument()</p></li><li><p>get optional()</p></li><li><p>get chunksIterable()</p></li></ul><blockquote><p>实例方法</p></blockquote><ul><li><p>disconnect()</p></li><li><p>unseal()</p></li><li><p>setChunks(chunks)</p></li><li><p>addChunk(chunk)</p></li><li><p>removeChunk(chunk)</p></li><li><p>isInChunk(chunk)</p></li><li><p>isEntryModule()</p></li><li><p>getChunks()</p></li><li><p>getNumberOfChunks()</p></li><li><p>hasEqualsChunks(otherModule)</p></li><li><p>addReason(module, dependency, explanation)</p></li><li><p>removeReason(module, dependency)</p></li><li><p>hasReasonForChunk(chunk)</p></li><li><p>hasReasons()</p></li><li><p>rewriteChunkInReasons(oldChunk, newChunks)</p></li><li><p>isUsed(exportName)</p></li><li><p>isProvided(exportName)</p></li><li><p>toString()</p></li><li><p>updateHash(hash)</p></li><li><p>sortItems(sortChunks)</p></li></ul><h3 id="NormalModule"><a href="#NormalModule" class="headerlink" title="NormalModule"></a>NormalModule</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NormalModule</span> <span class="keyword">extends</span> <span class="title">Module</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="Template-类"><a href="#Template-类" class="headerlink" title="Template 类"></a>Template 类</h2><blockquote><p>各种<code>Module</code>会有对应的<code>Template</code>，用来拼接相关字符串（一些注释等）和源代码字符串的。</p></blockquote><ul><li>MainTemplate: 用来操作入口文件的。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;compilation&quot;&gt;&lt;a href=&quot;#compilation&quot; class=&quot;headerlink&quot; title=&quot;compilation&quot;&gt;&lt;/a&gt;compilation&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;实例方法：&lt;/p&gt;
&lt;/blockquot
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>babel-traverse API</title>
    <link href="https://xxxxxmiss.github.io/2018/12/27/babel-traverse-api/"/>
    <id>https://xxxxxmiss.github.io/2018/12/27/babel-traverse-api/</id>
    <published>2018-12-27T02:45:55.000Z</published>
    <updated>2018-12-27T16:22:45.763Z</updated>
    
    <content type="html"><![CDATA[<h2 id="父节点相关"><a href="#父节点相关" class="headerlink" title="父节点相关"></a>父节点相关</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findParent(callback): ?NodePath</span><br></pre></td></tr></table></figure><blockquote><p>从当前节点的父节点（不包括当前节点自己）开始向上查找并调用 callback，如果 callback 返回一个真值，那么返回那个父节点；都没有找到，返回 null。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find(callback): ?NodePath</span><br></pre></td></tr></table></figure><blockquote><p>同<code>findParent</code>，唯一的区别是从当前节点（包括自己）开始查找。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getFunctionParent(): ?NodePath</span><br></pre></td></tr></table></figure><blockquote><p>找到满足 callback 的函数父节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getStatementParent(): NodePath</span><br></pre></td></tr></table></figure><blockquote><p>向上遍历节点树，直到命中一个处于<code>list</code>中的父节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getEarliestCommonAncestorFrom(</span><br><span class="line">  paths: <span class="built_in">Array</span>&lt;NodePath&gt;,</span><br><span class="line">): NodePath</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getDeepestCommonAncestorFrom(</span><br><span class="line">  paths: <span class="built_in">Array</span>&lt;NodePath&gt;,</span><br><span class="line">  filter?: <span class="built_in">Function</span>,</span><br><span class="line">): NodePath</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getAncestry(): <span class="built_in">Array</span>&lt;NodePath&gt;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isAncestor(maybeDescendant: NodePath): boolean</span><br></pre></td></tr></table></figure><blockquote><p>判断当前的<code>path</code>是否是<code>maybeDescendant</code>的祖先节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isDescendant(maybeAncestor: NodePath): boolean</span><br></pre></td></tr></table></figure><blockquote><p>判断当前的<code>path</code>是否是<code>maybeAncestor</code>的后代。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inType(): boolean</span><br></pre></td></tr></table></figure><blockquote><p>向上查找，直到一个节点的<code>type</code>在提供的<code>type</code>列表中为止，此时返回 ture，否则 false。</p></blockquote><h2 id="兄弟节点相关"><a href="#兄弟节点相关" class="headerlink" title="兄弟节点相关"></a>兄弟节点相关</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getOpposite(): ?NodePath</span><br></pre></td></tr></table></figure><blockquote><p>得到一个对立的节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getCompletionRecords(): <span class="built_in">Array</span></span><br></pre></td></tr></table></figure><blockquote><p>得到一个完整到的记录。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// key: 即为path.key</span></span><br><span class="line">getSibling(key): NodePath</span><br></pre></td></tr></table></figure><blockquote><p>根据<code>key</code>得到一个兄弟节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getPrevSibling(): NodePath</span><br></pre></td></tr></table></figure><blockquote><p>得到当前节点的前一个节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getNextSibling(): NodePath</span><br></pre></td></tr></table></figure><blockquote><p>得到当前节点的下一个节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getAllNextSiblings(): <span class="built_in">Array</span>&lt;NodePath&gt;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getAllPrevSiblings(): <span class="built_in">Array</span>&lt;NodePath&gt;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">get(</span><br><span class="line">  key: string,</span><br><span class="line">  context?: boolean | TraversalContext,</span><br><span class="line">): NodePath</span><br></pre></td></tr></table></figure><blockquote><p>根据字符串路径得到一个节点，类似于<code>lodash</code>中的<code>get</code>方法：<code>path.get(&#39;body.0&#39;)</code>。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getBindingIdentifiers(duplicates?): <span class="built_in">Object</span></span><br></pre></td></tr></table></figure><blockquote><p>获取绑定的标示，如：</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>, &#123; d &#125; = b, [c] = e</span><br><span class="line"><span class="comment">//       ⬇</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">&#123; <span class="attr">a</span>:</span><br><span class="line">   Node &#123;</span><br><span class="line">     type: <span class="string">'Identifier'</span>,</span><br><span class="line">     start: <span class="number">4</span>,</span><br><span class="line">     end: <span class="number">5</span>,</span><br><span class="line">     loc:</span><br><span class="line">      SourceLocation &#123; <span class="attr">start</span>: [Position], <span class="attr">end</span>: [Position], <span class="attr">identifierName</span>: <span class="string">'a'</span> &#125;,</span><br><span class="line">     name: <span class="string">'a'</span> &#125;,</span><br><span class="line">  d:</span><br><span class="line">   Node &#123;</span><br><span class="line">     type: <span class="string">'Identifier'</span>,</span><br><span class="line">     start: <span class="number">27</span>,</span><br><span class="line">     end: <span class="number">28</span>,</span><br><span class="line">     loc:</span><br><span class="line">      SourceLocation &#123; <span class="attr">start</span>: [Position], <span class="attr">end</span>: [Position], <span class="attr">identifierName</span>: <span class="string">'d'</span> &#125;,</span><br><span class="line">     name: <span class="string">'d'</span> &#125;,</span><br><span class="line">  b:</span><br><span class="line">   Node &#123;</span><br><span class="line">     type: <span class="string">'Identifier'</span>,</span><br><span class="line">     start: <span class="number">15</span>,</span><br><span class="line">     end: <span class="number">16</span>,</span><br><span class="line">     loc:</span><br><span class="line">      SourceLocation &#123; <span class="attr">start</span>: [Position], <span class="attr">end</span>: [Position], <span class="attr">identifierName</span>: <span class="string">'b'</span> &#125;,</span><br><span class="line">     name: <span class="string">'b'</span> &#125; &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getOuterBindingIdentifiers(duplicates?): <span class="built_in">Object</span></span><br></pre></td></tr></table></figure><blockquote><p>获取函数外层绑定的标识符，如：</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// ⬇</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">&#123; <span class="attr">f</span>:</span><br><span class="line">   Node &#123;</span><br><span class="line">     type: <span class="string">'Identifier'</span>,</span><br><span class="line">     start: <span class="number">43</span>,</span><br><span class="line">     end: <span class="number">44</span>,</span><br><span class="line">     loc:</span><br><span class="line">      SourceLocation &#123; <span class="attr">start</span>: [Position], <span class="attr">end</span>: [Position], <span class="attr">identifierName</span>: <span class="string">'f'</span> &#125;,</span><br><span class="line">     name: <span class="string">'f'</span> &#125; &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getBindingIdentifierPaths((duplicates = <span class="literal">false</span>), (outerOnly = <span class="literal">false</span>))</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getOuterBindingIdentifierPaths(duplicates?)</span><br></pre></td></tr></table></figure><h2 id="当前节点自身相关"><a href="#当前节点自身相关" class="headerlink" title="当前节点自身相关"></a>当前节点自身相关</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">matchesPattern(</span><br><span class="line">  pattern: string,</span><br><span class="line">  allowPartial?: boolean,</span><br><span class="line">): boolean</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">has(key): boolean</span><br></pre></td></tr></table></figure><blockquote><p>别名：<code>is</code></p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isnt(key): boolean</span><br></pre></td></tr></table></figure><blockquote><p><code>has</code>的否定操作。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">equals(key, value): boolean</span><br></pre></td></tr></table></figure><blockquote><p>检查当前节点的<code>key</code>是否等于给定的<code>value</code>。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isNodeType(type: string): boolean</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canHaveVariableDeclarationOrExpression()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canSwapBetweenExpressionAndStatement(replacement)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isStatic()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isCompletionRecord(allowInsideFunction?)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isStatementOrBlock()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">referencesImport(moduleSource, importName)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getSource()</span><br></pre></td></tr></table></figure><blockquote><p>获取当前节点的 souce 内容。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">willIMaybeExecuteBefore(target)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resolve(dangerous, resolved)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isConstantExpression()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isInStrictMode()</span><br></pre></td></tr></table></figure><blockquote><p>判断一个模块或者函数是否处于严格模式。<br>ES6 模块默认是处于严格模式，其实情况看是否使用<code>use strict</code>指令。</p></blockquote><h2 id="修改当前节点相关"><a href="#修改当前节点相关" class="headerlink" title="修改当前节点相关"></a>修改当前节点相关</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insertBefore(nodes)</span><br></pre></td></tr></table></figure><blockquote><p>在当前节点的前面插入节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insertAfter(nodes)</span><br></pre></td></tr></table></figure><blockquote><p>在当前节点的后面插入节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updateSiblingKeys(fromIndex, incrementBy)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unshiftContainer(listKey, nodes)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// listKey: path.listKey =&gt; "body" | "params"</span></span><br><span class="line">pushContainer(listKey, nodes)</span><br></pre></td></tr></table></figure><blockquote><p>将<code>nodes</code>放入到指定的<code>listKey</code>容器中，如：</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">a</span>) </span>&#123;&#125;</span><br><span class="line">path.pushContainer(<span class="string">'params'</span>, t.identifier(<span class="string">'b'</span>))</span><br><span class="line"><span class="comment">// ⬇</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">a, b</span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">path.pushContainer(<span class="string">'body'</span>, t.expressionStatement(t.identifier(<span class="string">'b'</span>)))</span><br><span class="line"><span class="comment">// ⬇</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">  b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hoist((scope = <span class="keyword">this</span>.scope))</span><br></pre></td></tr></table></figure><h2 id="删除当前节点相关"><a href="#删除当前节点相关" class="headerlink" title="删除当前节点相关"></a>删除当前节点相关</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remove()</span><br></pre></td></tr></table></figure><h2 id="替换当前节点相关"><a href="#替换当前节点相关" class="headerlink" title="替换当前节点相关"></a>替换当前节点相关</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replaceWithMultiple(nodes: <span class="built_in">Array</span>&lt;<span class="built_in">Object</span>&gt;)</span><br></pre></td></tr></table></figure><blockquote><p>用多个节点替换当前节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replaceWithSourceString(replacement)</span><br></pre></td></tr></table></figure><blockquote><p><em>不推荐使用</em><br>将<code>replacement</code>作为一个表达式去解析，然后用解析的结果替换当前节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replaceWith(replacement)</span><br></pre></td></tr></table></figure><blockquote><p>用一个节点替换当前节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replaceExpressionWithStatements(nodes: <span class="built_in">Array</span>&lt;<span class="built_in">Object</span>&gt;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replaceInline(nodes: <span class="built_in">Object</span> | <span class="built_in">Array</span>&lt;<span class="built_in">Object</span>&gt;)</span><br></pre></td></tr></table></figure><h2 id="注释相关"><a href="#注释相关" class="headerlink" title="注释相关"></a>注释相关</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shareCommentsWithSiblings()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addComment(type: string, <span class="attr">content</span>: string, line?: boolean)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addComments(type: string, <span class="attr">comments</span>: <span class="built_in">Array</span>)</span><br></pre></td></tr></table></figure><h2 id="上下文相关"><a href="#上下文相关" class="headerlink" title="上下文相关"></a>上下文相关</h2><blockquote><p>维护<code>TraversalContext</code>相关的方法。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call(key): boolean</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isBlacklisted(): boolean</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">visit(): boolean</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skip()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skipKey(key)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop()</span><br></pre></td></tr></table></figure><blockquote><p>停止继续往上或者往下遍历一个节点。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setScope()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setContext(context)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resync()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">popContext()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pushContext(context)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setup(parentPath, container, listKey, key)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setKey(key)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requeue((pathToQueue = <span class="keyword">this</span>))</span><br></pre></td></tr></table></figure><h2 id="节点类型转化"><a href="#节点类型转化" class="headerlink" title="节点类型转化"></a>节点类型转化</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ensureBlock()</span><br></pre></td></tr></table></figure><blockquote><p>将可以转化的节点（函数，for 循环等）转换成块节点，如：<code>() =&gt; true</code> =&gt; <code>() =&gt; { return true }</code>。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arrowFunctionToExpression(</span><br><span class="line">  (&#123; allowInsertArrow = <span class="literal">true</span>, specCompliant = <span class="literal">false</span> &#125; = &#123;&#125;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><blockquote><p>将一个箭头函数转化为 ES5 的函数表达式。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;父节点相关&quot;&gt;&lt;a href=&quot;#父节点相关&quot; class=&quot;headerlink&quot; title=&quot;父节点相关&quot;&gt;&lt;/a&gt;父节点相关&lt;/h2&gt;&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;p
      
    
    </summary>
    
      <category term="js" scheme="https://xxxxxmiss.github.io/categories/js/"/>
    
    
      <category term="js" scheme="https://xxxxxmiss.github.io/tags/js/"/>
    
      <category term="babel" scheme="https://xxxxxmiss.github.io/tags/babel/"/>
    
      <category term="babel-traverse" scheme="https://xxxxxmiss.github.io/tags/babel-traverse/"/>
    
  </entry>
  
  <entry>
    <title>finalhandler</title>
    <link href="https://xxxxxmiss.github.io/2018/12/04/finalhandler/"/>
    <id>https://xxxxxmiss.github.io/2018/12/04/finalhandler/</id>
    <published>2018-12-04T12:28:30.000Z</published>
    <updated>2018-12-04T14:49:01.531Z</updated>
    
    <content type="html"><![CDATA[<h2 id="finalhandler-简介"><a href="#finalhandler-简介" class="headerlink" title="finalhandler 简介"></a><a href="https://github.com/pillarjs/finalhandler" target="_blank" rel="noopener">finalhandler</a> 简介</h2><blockquote><p>作为最后一步去响应一个 http 请求。这个模块被用在<a href="https://github.com/senchalabs/connect" target="_blank" rel="noopener">connect</a>中，作为所有中间的最后一步去响应一个请求。</p></blockquote><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> finalhandler = <span class="built_in">require</span>(<span class="string">'finalhandler'</span>)</span><br></pre></td></tr></table></figure><p>finalhandler(req, res, [options])</p><blockquote><p>调用该函数，返回一个新的函数。这个新的函数会被传入一个<code>err</code>。<br>如果这个<code>err</code>是个<code>假值</code>，那么新的函数会将<code>res</code>的响应码设置为<code>404</code>。如果<code>err</code>是<code>真值</code>，那么响应一个错误的<code>res</code>。</p></blockquote><p>当错误发生时，以下信息会被设置到<code>res</code>上：</p><ul><li><p>会将<code>res</code>上的<code>status</code>或者<code>statusCode</code>设置到<code>res</code>上。如果该值小于<code>4xx</code>或者大于<code>5xx</code>，那么<code>res</code>上的<code>statusCode</code>会被设置为 500。</p></li><li><p>会依据<code>res.statusCode</code>设置<code>res.statusMessage</code>。</p></li><li><p>如果在生产环境下(process.env.NODE_ENV === ‘production’），会响应一个带有状态码信息的 html 页面。否则，打印堆栈信息。</p></li><li><p>任何头信息被指定在<code>err.headers</code>对象中。</p></li></ul><h3 id="options-env"><a href="#options-env" class="headerlink" title="options.env"></a>options.env</h3><blockquote><p>默认情况下，环境变量会通过<code>process.env.NODE_ENV</code>指定，可以通过该选项重写。</p></blockquote><h3 id="options-onerror"><a href="#options-onerror" class="headerlink" title="options.onerror"></a>options.onerror</h3><blockquote><p>指定一个错误处理函数，会按<code>onerror(error, req, res)</code>形式调用。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = finalhandler</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finalhandler</span>(<span class="params">req, res, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> opts = options || &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get environment</span></span><br><span class="line">  <span class="keyword">var</span> env = opts.env || process.env.NODE_ENV || <span class="string">'development'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// get error callback</span></span><br><span class="line">  <span class="keyword">var</span> onerror = opts.onerror</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> headers</span><br><span class="line">    <span class="keyword">var</span> msg</span><br><span class="line">    <span class="keyword">var</span> status</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ignore 404 on in-flight response</span></span><br><span class="line">    <span class="keyword">if</span> (!err &amp;&amp; headersSent(res)) &#123;</span><br><span class="line">      debug(<span class="string">'cannot 404 after headers sent'</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unhandled error</span></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="comment">// respect status code from error</span></span><br><span class="line">      <span class="comment">// 从err对象上取得合法的code</span></span><br><span class="line">      status = getErrorStatusCode(err)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (status === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="comment">// fallback to status code on response</span></span><br><span class="line">        <span class="comment">// 从res上取得合法的code</span></span><br><span class="line">        status = getResponseStatusCode(res)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// respect headers from error</span></span><br><span class="line">        <span class="comment">// 从err.headers上去的一个headers对象</span></span><br><span class="line">        headers = getErrorHeaders(err)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// get error message</span></span><br><span class="line">      <span class="comment">// 得到错误信息</span></span><br><span class="line">      msg = getErrorMessage(err, status, env)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果没有发生错误，那么设置status为404</span></span><br><span class="line">      <span class="comment">// not found</span></span><br><span class="line">      status = <span class="number">404</span></span><br><span class="line">      msg = <span class="string">'Cannot '</span> + req.method + <span class="string">' '</span> + encodeUrl(getResourceName(req))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">'default %s'</span>, status)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// schedule onerror callback</span></span><br><span class="line">    <span class="keyword">if</span> (err &amp;&amp; onerror) &#123;</span><br><span class="line">      defer(onerror, err, req, res)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cannot actually respond</span></span><br><span class="line">    <span class="keyword">if</span> (headersSent(res)) &#123;</span><br><span class="line">      debug(<span class="string">'cannot %d after headers sent'</span>, status)</span><br><span class="line">      req.socket.destroy()</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// send response</span></span><br><span class="line">    send(req, res, status, headers, msg)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从一个err对象上取得http状态码</span></span><br><span class="line"><span class="comment">// 优先从status上取，然后再从statusCode上取</span></span><br><span class="line"><span class="comment">// status或者statusCode必须是number类型，并且是一个有效的状态码（&gt;=400 &amp;&amp; &lt;600）</span></span><br><span class="line"><span class="comment">// 4xx代表的是客户端的错误，5xx代表的是服务端错误</span></span><br><span class="line"><span class="comment">// 1xx-3xx表示没有错误</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getErrorStatusCode</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// check err.status</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> err.status === <span class="string">'number'</span> &amp;&amp; err.status &gt;= <span class="number">400</span> &amp;&amp; err.status &lt; <span class="number">600</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> err.status</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check err.statusCode</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> err.statusCode === <span class="string">'number'</span> &amp;&amp;</span><br><span class="line">    err.statusCode &gt;= <span class="number">400</span> &amp;&amp;</span><br><span class="line">    err.statusCode &lt; <span class="number">600</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> err.statusCode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果通过getErrorStatusCodes没有取得状态码，那么从res.statusCode上查找</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getResponseStatusCode</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> status = res.statusCode</span><br><span class="line"></span><br><span class="line">  <span class="comment">// default status code to 500 if outside valid range</span></span><br><span class="line">  <span class="comment">// 如果status不是一个number类型，或者不是错误状态码或则超出了范围（是一个无效的状态码）</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> status !== <span class="string">'number'</span> || status &lt; <span class="number">400</span> || status &gt; <span class="number">599</span>) &#123;</span><br><span class="line">    <span class="comment">// 直接赋值为500</span></span><br><span class="line">    status = <span class="number">500</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 那么继续在err的headers对象上查找</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getErrorHeaders</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// err.headers应该是一个对象（此处简单的判断了下）</span></span><br><span class="line">  <span class="keyword">if</span> (!err.headers || <span class="keyword">typeof</span> err.headers !== <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> headers = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(err.headers)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将err.headers拷贝到headers上</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> key = keys[i]</span><br><span class="line">    headers[key] = err.headers[key]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> headers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据环境的不同，返回不同的错误信息</span></span><br><span class="line"><span class="comment">// 生产环境展示http code对应的错误信息</span></span><br><span class="line"><span class="comment">// 非生产环境展示错误堆栈信息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getErrorMessage</span> (<span class="params">err, status, env</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> msg</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (env !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="comment">// use err.stack, which typically includes err.message</span></span><br><span class="line">    msg = err.stack</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fallback to err.toString() when possible</span></span><br><span class="line">    <span class="keyword">if</span> (!msg &amp;&amp; <span class="keyword">typeof</span> err.toString === <span class="string">'function'</span>) &#123;</span><br><span class="line">      msg = err.toString()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> msg || statuses[status]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发送最终的响应：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span> (<span class="params">req, res, status, headers, message</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">write</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// response body</span></span><br><span class="line">    <span class="keyword">var</span> body = createHtmlDocument(message)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// response status</span></span><br><span class="line">    res.statusCode = status</span><br><span class="line">    res.statusMessage = statuses[status]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// response headers</span></span><br><span class="line">    setHeaders(res, headers)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// security headers</span></span><br><span class="line">    res.setHeader(<span class="string">'Content-Security-Policy'</span>, <span class="string">"default-src 'self'"</span>)</span><br><span class="line">    res.setHeader(<span class="string">'X-Content-Type-Options'</span>, <span class="string">'nosniff'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// standard headers</span></span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html; charset=utf-8'</span>)</span><br><span class="line">    res.setHeader(<span class="string">'Content-Length'</span>, Buffer.byteLength(body, <span class="string">'utf8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req.method === <span class="string">'HEAD'</span>) &#123;</span><br><span class="line">      res.end()</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.end(body, <span class="string">'utf8'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isFinished(req)) &#123;</span><br><span class="line">    write()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// unpipe everything from the request</span></span><br><span class="line">  unpipe(req)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// flush the request</span></span><br><span class="line">  onFinished(req, write)</span><br><span class="line">  req.resume()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;finalhandler-简介&quot;&gt;&lt;a href=&quot;#finalhandler-简介&quot; class=&quot;headerlink&quot; title=&quot;finalhandler 简介&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://github.com/pillarjs/fina
      
    
    </summary>
    
      <category term="nodejs" scheme="https://xxxxxmiss.github.io/categories/nodejs/"/>
    
    
      <category term="nodejs" scheme="https://xxxxxmiss.github.io/tags/nodejs/"/>
    
      <category term="finalhandler" scheme="https://xxxxxmiss.github.io/tags/finalhandler/"/>
    
      <category term="http" scheme="https://xxxxxmiss.github.io/tags/http/"/>
    
  </entry>
  
  <entry>
    <title>connect源码解读</title>
    <link href="https://xxxxxmiss.github.io/2018/11/27/connect/"/>
    <id>https://xxxxxmiss.github.io/2018/11/27/connect/</id>
    <published>2018-11-27T14:02:53.000Z</published>
    <updated>2018-12-02T11:30:06.169Z</updated>
    
    <content type="html"><![CDATA[<h2 id="connect-简介"><a href="#connect-简介" class="headerlink" title="connect 简介"></a>connect 简介</h2><blockquote><p>connect 是一款极简的 web 框架，串联各种中间件来处理请求。</p></blockquote><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// require module</span></span><br><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// create app</span></span><br><span class="line"><span class="keyword">const</span> app = connect()</span><br></pre></td></tr></table></figure><h3 id="app-req-res-next"><a href="#app-req-res-next" class="headerlink" title="app(req, res[, next])"></a>app(req, res[, next])</h3><blockquote><p><code>app</code>本身也是一个函数，他是<code>app.handle</code>的一个别名。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = createServer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createServer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">app</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    app.handle(req, res, next)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将proto上的方法拷贝到app上</span></span><br><span class="line">  <span class="comment">// proto是一个对象，该对象上只有use, handle, listen三个方法</span></span><br><span class="line">  merge(app, proto)</span><br><span class="line">  <span class="comment">// 将EventEmitter原型链上的方法拷贝到app上</span></span><br><span class="line">  merge(app, EventEmitter.prototype)</span><br><span class="line">  app.route = <span class="string">'/'</span></span><br><span class="line">  <span class="comment">// 该stack属性就是用来存放所有的中间件</span></span><br><span class="line">  app.stack = []</span><br><span class="line">  <span class="comment">// 返回的是一个function，并且接收(req, res, next)形式的参数</span></span><br><span class="line">  <span class="comment">// 这样就可以将这个返回的函数传入到nodejs原生的http或者https的createServer中</span></span><br><span class="line">  <span class="comment">// 后面要解读的listen方法，默认使用http模块</span></span><br><span class="line">  <span class="comment">// 通过返回这种形式的函数，就可以在http或者https模块之间切换</span></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="app-listen-…"><a href="#app-listen-…" class="headerlink" title="app.listen([…])"></a>app.listen([…])</h3><blockquote><p>就是对 nodejs 中<code>http.Server#listen</code>方法一个简单的封装。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">proto.listen = <span class="function"><span class="keyword">function</span> <span class="title">listen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 因为调用都是通过app.listen，所有此处的this就是app</span></span><br><span class="line">  <span class="comment">// 而上面已经介绍了app是一个接收(req, res, next)的函数</span></span><br><span class="line">  <span class="keyword">var</span> server = http.createServer(<span class="keyword">this</span>)</span><br><span class="line">  <span class="comment">// 调用server上的listen方法</span></span><br><span class="line">  <span class="keyword">return</span> server.listen.apply(server, <span class="built_in">arguments</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="app-use-fn"><a href="#app-use-fn" class="headerlink" title="app.use(fn)"></a>app.use(fn)</h3><blockquote><p>这个方法就是添加各种中间件到<code>app.stack</code>中。<br>还有一个类似的方法<code>app.use(route, fn)</code>，其实<code>app.use(fn)</code>可以看成是<code>app.use(&#39;/&#39;, fn)</code>。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">proto.use = <span class="function"><span class="keyword">function</span> <span class="title">use</span>(<span class="params">route, fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> handle = fn</span><br><span class="line">  <span class="keyword">var</span> path = route</span><br><span class="line"></span><br><span class="line">  <span class="comment">// default route to '/'</span></span><br><span class="line">  <span class="comment">// 这个就是处理app.use(fn)的情况</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> route !== <span class="string">'string'</span>) &#123;</span><br><span class="line">    handle = route</span><br><span class="line">    path = <span class="string">'/'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wrap sub-apps</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handle.handle === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> server = handle</span><br><span class="line">    server.route = path</span><br><span class="line">    handle = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">      server.handle(req, res, next)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wrap vanilla http.Servers</span></span><br><span class="line">  <span class="comment">// 这种情况用来处理fn是一个http.Server实例，</span></span><br><span class="line">  <span class="comment">// 就是说你可以传入一个http.Server实例作为中间件</span></span><br><span class="line">  <span class="keyword">if</span> (handle <span class="keyword">instanceof</span> http.Server) &#123;</span><br><span class="line">    <span class="comment">// 因为http.Server继承了EventEmitter,所以有listeners方法</span></span><br><span class="line">    <span class="comment">// 取request事件中的第一个监听器作为中间件</span></span><br><span class="line">    handle = handle.listeners(<span class="string">'request'</span>)[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// strip trailing slash</span></span><br><span class="line">  <span class="comment">// 当你请求的路径为`/path/name/`,就是末尾带有斜杆</span></span><br><span class="line">  <span class="comment">// 那么会剔除末尾的斜杆</span></span><br><span class="line">  <span class="comment">// 其实路径末尾带有斜杆，表示的是一个文件夹，</span></span><br><span class="line">  <span class="keyword">if</span> (path[path.length - <span class="number">1</span>] === <span class="string">'/'</span>) &#123;</span><br><span class="line">    path = path.slice(<span class="number">0</span>, <span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add the middleware</span></span><br><span class="line">  debug(<span class="string">'use %s %s'</span>, path || <span class="string">'/'</span>, handle.name || <span class="string">'anonymous'</span>)</span><br><span class="line">  <span class="comment">// 将中间件和请求的路径添加到一个对象上，然后将该对象推入app.stack中</span></span><br><span class="line">  <span class="keyword">this</span>.stack.push(&#123; <span class="attr">route</span>: path, <span class="attr">handle</span>: handle &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回app，可以形成链式调用，如： app.use(fn).listen()</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="app-handle-req-res-out"><a href="#app-handle-req-res-out" class="headerlink" title="app.handle(req, res[, out])"></a>app.handle(req, res[, out])</h3><blockquote><p>这个方法用来处理服务器请求，模块导出的 app 内部就是调用该方法。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">proto.handle = <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">req, res, out</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 这个变量用来控制中间件是否已经全部结束</span></span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 得到协议+主机部分</span></span><br><span class="line">  <span class="comment">// getProtohost的解释看下面</span></span><br><span class="line">  <span class="keyword">var</span> protohost = getProtohost(req.url) || <span class="string">''</span></span><br><span class="line">  <span class="comment">// 要移除的route部分</span></span><br><span class="line">  <span class="keyword">var</span> removed = <span class="string">''</span></span><br><span class="line">  <span class="comment">// 是否在path的最前面添加过'/'的标记</span></span><br><span class="line">  <span class="keyword">var</span> slashAdded = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// 拿到所有的中间件</span></span><br><span class="line">  <span class="keyword">var</span> stack = <span class="keyword">this</span>.stack</span><br><span class="line"></span><br><span class="line">  <span class="comment">// final function handler</span></span><br><span class="line">  <span class="comment">// 可以指定自己的最终处理函数（所有的中间件都执行完毕后调用）</span></span><br><span class="line">  <span class="comment">// 如果没有指定，那么使用`finalhandler`模块来处理</span></span><br><span class="line">  <span class="keyword">var</span> done =</span><br><span class="line">    out ||</span><br><span class="line">    finalhandler(req, res, &#123;</span><br><span class="line">      env: env,</span><br><span class="line">      onerror: logerror</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// store the original URL</span></span><br><span class="line">  <span class="comment">// 因为我们要对一些边缘情况的url做处理，</span></span><br><span class="line">  <span class="comment">// 所以此处会把请求原始的url挂载到req的originUrl上</span></span><br><span class="line">  req.originalUrl = req.originalUrl || req.url</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这个next方法就是每个中间件中最后一个参数next</span></span><br><span class="line">  <span class="comment">// 使用它来控制是否继续执行下一个中间件</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果手动添加过path部分前面的'/',</span></span><br><span class="line">    <span class="comment">// 那么此处先去掉前面的'/',并且将slashAdded标记重置为false</span></span><br><span class="line">    <span class="keyword">if</span> (slashAdded) &#123;</span><br><span class="line">      req.url = req.url.substr(<span class="number">1</span>)</span><br><span class="line">      slashAdded = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表明有移除的部分</span></span><br><span class="line">    <span class="keyword">if</span> (removed.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 那么完整的url应该为protohost + removed + path（这一部分是去掉removed，剩下的部分）</span></span><br><span class="line">      req.url = protohost + removed + req.url.substr(protohost.length)</span><br><span class="line">      <span class="comment">// 将removed置空</span></span><br><span class="line">      removed = <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// next callback</span></span><br><span class="line">    <span class="comment">// 每次调用next都会从stack中取出一个中间件</span></span><br><span class="line">    <span class="keyword">var</span> layer = stack[index++]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// all done</span></span><br><span class="line">    <span class="comment">// 如果不存在，说明中间件已经全部执行完毕，</span></span><br><span class="line">    <span class="comment">// 那么执行最后的一个收尾操作</span></span><br><span class="line">    <span class="comment">// 你可以自定义收尾操作，没有定义就使用finalhandler这个模块来处理</span></span><br><span class="line">    <span class="keyword">if</span> (!layer) &#123;</span><br><span class="line">      defer(done, err)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// route data</span></span><br><span class="line">    <span class="comment">// parseUrl是一个npm包，功能跟nodjs自带的url模块的parse方法一样，</span></span><br><span class="line">    <span class="comment">// 只不过加入了缓存处理，如果每次拿到相同的url就不在解析，直接返回缓存中的结果</span></span><br><span class="line">    <span class="comment">// 这个path是你请求的path</span></span><br><span class="line">    <span class="keyword">var</span> path = parseUrl(req).pathname || <span class="string">'/'</span></span><br><span class="line">    <span class="comment">// 这个route是你在调用app.use(route, fn)中的route</span></span><br><span class="line">    <span class="keyword">var</span> route = layer.route</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skip this layer if the route doesn't match</span></span><br><span class="line">    <span class="comment">// 因为url是不区分大小写的,所以此处使用toLowerCase来统一处理</span></span><br><span class="line">    <span class="comment">// 如果route为：/blog，path为：/blog/post，</span></span><br><span class="line">    <span class="comment">// 这个时候app.use('/blog', fn)中的fn是会执行的</span></span><br><span class="line">    <span class="comment">// 此处用来处理path和route没有这种包含关系，那么跳过执行fn</span></span><br><span class="line">    <span class="keyword">if</span> (path.toLowerCase().substr(<span class="number">0</span>, route.length) !== route.toLowerCase()) &#123;</span><br><span class="line">      <span class="keyword">return</span> next(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skip if route match does not border "/", ".", or end</span></span><br><span class="line">    <span class="comment">// 如果path为：/blog-post, route为：/blog</span></span><br><span class="line">    <span class="comment">// 这种情况不满足包含关系，那么也跳过这个中间件的执行</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果path为：/blog.或者/blog/, route为：/blog</span></span><br><span class="line">    <span class="comment">// 这种情况也视为满足包含关系，也就是说会执行对应的中间件</span></span><br><span class="line">    <span class="keyword">var</span> c = path.length &gt; route.length &amp;&amp; path[route.length]</span><br><span class="line">    <span class="keyword">if</span> (c &amp;&amp; c !== <span class="string">'/'</span> &amp;&amp; c !== <span class="string">'.'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> next(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trim off the part of the url that matches the route</span></span><br><span class="line">    <span class="keyword">if</span> (route.length !== <span class="number">0</span> &amp;&amp; route !== <span class="string">'/'</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果route为：/blog，path为：/blog/post</span></span><br><span class="line">      <span class="comment">// 那么该url会被处理成 protohost + '/post'</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// route这段会被移除</span></span><br><span class="line">      removed = route</span><br><span class="line">      <span class="comment">// ①</span></span><br><span class="line">      req.url = protohost + req.url.substr(protohost.length + removed.length)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ensure leading slash</span></span><br><span class="line">      <span class="comment">// getProtohost函数可以知道，可能没有得到协议加主机部分</span></span><br><span class="line">      <span class="comment">// 并且有可能你请求的path为'/'，</span></span><br><span class="line">      <span class="comment">// 那么上面①处得到url就为空('')</span></span><br><span class="line">      <span class="comment">// 所以此处的操作确在这种情况下,url前面有个`/`</span></span><br><span class="line">      <span class="keyword">if</span> (!protohost &amp;&amp; req.url[<span class="number">0</span>] !== <span class="string">'/'</span>) &#123;</span><br><span class="line">        req.url = <span class="string">'/'</span> + req.url</span><br><span class="line">        <span class="comment">// 表明已经添加过'/'</span></span><br><span class="line">        slashAdded = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call the layer handle</span></span><br><span class="line">    <span class="comment">// 开始调用中间件</span></span><br><span class="line">    call(layer.handle, route, err, req, res, next)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过<code>getProtohost</code>函数得到一个 url 的<em>协议+主机</em>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getProtohost</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果url为一个空字符串</span></span><br><span class="line">  <span class="comment">// 或者是以`/`开头，那么表明不带有协议部分</span></span><br><span class="line">  <span class="comment">// 那么直接返回undefined</span></span><br><span class="line">  <span class="keyword">if</span> (url.length === <span class="number">0</span> || url[<span class="number">0</span>] === <span class="string">'/'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 找到search出现的位置</span></span><br><span class="line">  <span class="keyword">var</span> searchIndex = url.indexOf(<span class="string">'?'</span>)</span><br><span class="line">  <span class="keyword">var</span> pathLength = searchIndex !== <span class="number">-1</span> ? searchIndex : url.length</span><br><span class="line">  <span class="comment">// 从url中找到`://`出现的位置</span></span><br><span class="line">  <span class="keyword">var</span> fqdnIndex = url.substr(<span class="number">0</span>, pathLength).indexOf(<span class="string">'://'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果url中含有`://`，那么表示这是一个带有协议的url</span></span><br><span class="line">  <span class="keyword">return</span> fqdnIndex !== <span class="number">-1</span></span><br><span class="line">    ? <span class="comment">// 得到path中第一次出现`/`前面的部分，也就是协议+主机</span></span><br><span class="line">      url.substr(<span class="number">0</span>, url.indexOf(<span class="string">'/'</span>, <span class="number">3</span> + fqdnIndex))</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>关于一个 url 中的各个部分的名称，可以看下图：</p></blockquote><img src="/2018/11/27/connect/url-segments.png" title="url片段术语"><p>上面的介绍的<code>next</code>方法用来控制是否继续执行下一个中间件，此处的<code>call</code>方法就是用来执行某一个中间件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// handle，就是每一个中间件</span></span><br><span class="line"><span class="comment">// route，就是调用app.use(route,fn)中的route，在该函数中没有什么特别的用处，主要用来显示日志</span></span><br><span class="line"><span class="comment">// err，调用错误中间件中的err</span></span><br><span class="line"><span class="comment">// req，http.IncommingMessage</span></span><br><span class="line"><span class="comment">// res，http.ServerResponse</span></span><br><span class="line"><span class="comment">// next，上面介绍的next</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params">handle, route, err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 函数的形参个数</span></span><br><span class="line">  <span class="keyword">var</span> arity = handle.length</span><br><span class="line">  <span class="keyword">var</span> error = err</span><br><span class="line">  <span class="keyword">var</span> hasError = <span class="built_in">Boolean</span>(err)</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'%s %s : %s'</span>, handle.name || <span class="string">'&lt;anonymous&gt;'</span>, route, req.originalUrl)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 经过此处的条件语句，我们可以知道</span></span><br><span class="line">    <span class="comment">// 在你调用使用错误中间件的时候，形参一定要是4个参数</span></span><br><span class="line">    <span class="comment">// 多余4个或者少于4个都不会执行</span></span><br><span class="line">    <span class="keyword">if</span> (hasError &amp;&amp; arity === <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="comment">// error-handling middleware</span></span><br><span class="line">      handle(err, req, res, next)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasError &amp;&amp; arity &lt; <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="comment">// 不是错误中间件，那么形参一定要小于4个</span></span><br><span class="line">      <span class="comment">// request-handling middleware</span></span><br><span class="line">      handle(req, res, next)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// replace the error</span></span><br><span class="line">    error = e</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// continue</span></span><br><span class="line">  <span class="comment">// 当前中间件执行完毕后，调用next来启动下一个中间件的执行</span></span><br><span class="line">  <span class="comment">// 并且将error对象一直传递下去</span></span><br><span class="line">  next(error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;connect-简介&quot;&gt;&lt;a href=&quot;#connect-简介&quot; class=&quot;headerlink&quot; title=&quot;connect 简介&quot;&gt;&lt;/a&gt;connect 简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;connect 是一款极简的 web 框架，串联各
      
    
    </summary>
    
      <category term="nodejs" scheme="https://xxxxxmiss.github.io/categories/nodejs/"/>
    
    
      <category term="nodejs" scheme="https://xxxxxmiss.github.io/tags/nodejs/"/>
    
      <category term="http" scheme="https://xxxxxmiss.github.io/tags/http/"/>
    
      <category term="connect" scheme="https://xxxxxmiss.github.io/tags/connect/"/>
    
  </entry>
  
  <entry>
    <title>ee-first源码解读</title>
    <link href="https://xxxxxmiss.github.io/2018/11/26/ee-first/"/>
    <id>https://xxxxxmiss.github.io/2018/11/26/ee-first/</id>
    <published>2018-11-26T13:51:16.000Z</published>
    <updated>2018-11-27T13:36:29.965Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ee-first"><a href="#ee-first" class="headerlink" title="ee-first"></a>ee-first</h2><blockquote><p>从一个事件列表中触发一个事件，一旦触发了该事件之后，就会移除该事件及其他所有的事件。</p></blockquote><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> first = <span class="built_in">require</span>(<span class="string">'ee-first'</span>)</span><br></pre></td></tr></table></figure><h3 id="first-arr-listener"><a href="#first-arr-listener" class="headerlink" title="first(arr, listener)"></a>first(arr, listener)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ee1 = <span class="keyword">new</span> EventEmitter()</span><br><span class="line"><span class="keyword">const</span> ee2 = <span class="keyword">new</span> EventEmitter()</span><br><span class="line">first(</span><br><span class="line">  [[ee1, <span class="string">'end'</span>, <span class="string">'finish'</span>], [ee1, <span class="string">'error'</span>, <span class="string">'end'</span>]],</span><br><span class="line">  (error, ee, event, args) =&gt; &#123;</span><br><span class="line">    <span class="comment">// listener invoked</span></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心代码</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">first</span>(<span class="params">stuff, done</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// stuff类型校验，略去</span></span><br><span class="line">  <span class="keyword">var</span> cleanups = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stuff.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> arr = stuff[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// arr类型校验，略去</span></span><br><span class="line">    <span class="keyword">var</span> ee = arr[<span class="number">0</span>] <span class="comment">// EventEmitter实例</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">1</span>; j &lt; arr.length; j++) &#123;</span><br><span class="line">      <span class="keyword">var</span> event = arr[j] <span class="comment">// 事件名</span></span><br><span class="line">      <span class="keyword">var</span> fn = listener(event, callback)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// listen to the event</span></span><br><span class="line">      <span class="comment">// 此处只要触发了一个事件，结合下面`listener`的分析得知，</span></span><br><span class="line">      <span class="comment">// 那么最终会执行callback，而该callback就是清除所有的EventEmitter实例上的所有事件</span></span><br><span class="line">      ee.on(event, fn)</span><br><span class="line">      <span class="comment">// push this listener to the list of cleanups</span></span><br><span class="line">      cleanups.push(&#123;</span><br><span class="line">        ee: ee,</span><br><span class="line">        event: event,</span><br><span class="line">        fn: fn</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这个callback就是`listener`函数中的done</span></span><br><span class="line">  <span class="comment">// 执行该函数会传递进来`err`, `ee`, `event`, `args`</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    cleanup()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有此处执行入口函数中的done, 并传入上面的4个参数</span></span><br><span class="line">    done.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">cleanup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cleanups.length; i++) &#123;</span><br><span class="line">      x = cleanups[i]</span><br><span class="line">      x.ee.removeListener(x.event, x.fn)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">thunk</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    done = fn</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  thunk.cancel = cleanup</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 此处返回一个thunk函数，通过该函数上的cancel方法，</span></span><br><span class="line">  <span class="comment">// 可以直接清除所有EventEmitter实例上的所有事件</span></span><br><span class="line">  <span class="keyword">return</span> thunk</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listener</span>(<span class="params">event, done</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 因为返回的onevent会作为指定事件的监听器</span></span><br><span class="line">  <span class="comment">// 当执行该事件监听器是，`this`指向该EventEmitter实例</span></span><br><span class="line">  <span class="comment">// 如果使用箭头函数，那么`this`就不指向EventEmitter实例了</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">onevent</span>(<span class="params">arg1</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="built_in">arguments</span>.length)</span><br><span class="line">    <span class="keyword">var</span> ee = <span class="keyword">this</span></span><br><span class="line">    <span class="comment">// 如果监听的是一个error事件，那么第一个参数就是执行该监听器传递进来的参数（一个错误对象）</span></span><br><span class="line">    <span class="comment">// 监听的其他事件，那么该参数设置为null</span></span><br><span class="line">    <span class="keyword">var</span> err = event === <span class="string">'error'</span> ? arg1 : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy args to prevent arguments escaping scope</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">      args[i] = <span class="built_in">arguments</span>[i]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最终会执行传递进来的done</span></span><br><span class="line">    done(err, ee, event, args)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cancel"><a href="#cancel" class="headerlink" title=".cancel()"></a>.cancel()</h3><blockquote><p>直接移除所有<code>EventEmitter</code>实例上的所有监听器</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ee-first&quot;&gt;&lt;a href=&quot;#ee-first&quot; class=&quot;headerlink&quot; title=&quot;ee-first&quot;&gt;&lt;/a&gt;ee-first&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;从一个事件列表中触发一个事件，一旦触发了该事件之后，就会移除该事件
      
    
    </summary>
    
      <category term="nodejs" scheme="https://xxxxxmiss.github.io/categories/nodejs/"/>
    
    
      <category term="nodejs" scheme="https://xxxxxmiss.github.io/tags/nodejs/"/>
    
      <category term="events" scheme="https://xxxxxmiss.github.io/tags/events/"/>
    
      <category term="ee-first" scheme="https://xxxxxmiss.github.io/tags/ee-first/"/>
    
  </entry>
  
  <entry>
    <title>http-range</title>
    <link href="https://xxxxxmiss.github.io/2018/11/21/http-range/"/>
    <id>https://xxxxxmiss.github.io/2018/11/21/http-range/</id>
    <published>2018-11-21T13:46:00.000Z</published>
    <updated>2018-12-06T06:41:57.164Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Range-简介"><a href="#Range-简介" class="headerlink" title="Range 简介"></a>Range 简介</h2><blockquote><p><em>Range</em>是一个请求首部，告知服务器返回文件的哪一部分。在一个<em>Range</em>首部中，可以一次性请求多个部分，服务器会以<em>multipart</em>文件的形式将其返回。</p></blockquote><ul><li>如果服务器返回的是范围响应，需要使用<code>206 Partial Content</code>状态码。</li><li>假如所请求的范围不合法，那么服务器会返回<code>416 Range Not Satisfiable</code>状态码，表示客户端错误。</li><li>服务器允许忽略 Range 首部，从而返回整个文件，状态码用<code>200</code> 。</li></ul><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><blockquote><p>Range: &lt;unit&gt;=&lt;range-start&gt;-<br>Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;<br>Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;<br>Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;</p></blockquote><h2 id="range-parser源码解读"><a href="#range-parser源码解读" class="headerlink" title="range-parser源码解读"></a><a href="https://github.com/jshttp/range-parser" target="_blank" rel="noopener">range-parser</a>源码解读</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rangeParser</span>(<span class="params">size, str, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> str !== <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'argument str must be a string'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> index = str.indexOf(<span class="string">'='</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (index === <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="comment">// -2： 表示str是一个不符合range语法的字符串</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-2</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// split the range string</span></span><br><span class="line">  <span class="comment">// 将多个range以逗号分割</span></span><br><span class="line">  <span class="keyword">var</span> arr = str.slice(index + <span class="number">1</span>).split(<span class="string">','</span>)</span><br><span class="line">  <span class="keyword">var</span> ranges = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add ranges type</span></span><br><span class="line">  <span class="comment">// 获取单位&lt;unit&gt;，这个单位一般为bytes</span></span><br><span class="line">  ranges.type = str.slice(<span class="number">0</span>, index)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// parse all ranges</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> range = arr[i].split(<span class="string">'-'</span>)</span><br><span class="line">    <span class="keyword">var</span> start = <span class="built_in">parseInt</span>(range[<span class="number">0</span>], <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">var</span> end = <span class="built_in">parseInt</span>(range[<span class="number">1</span>], <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -nnn</span></span><br><span class="line">    <span class="comment">// 如果没有起始范围（索引），如：bytes=-10</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isNaN</span>(start)) &#123;</span><br><span class="line">      start = size - end</span><br><span class="line">      end = size - <span class="number">1</span></span><br><span class="line">      <span class="comment">// nnn-</span></span><br><span class="line">      <span class="comment">// 如果没有结束范围（索引），如：bytes=10-</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">isNaN</span>(end)) &#123;</span><br><span class="line">      end = size - <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// limit last-byte-pos to current length</span></span><br><span class="line">    <span class="comment">// 如果结束索引超出了最大索引，那么设置结束索引为最大索引</span></span><br><span class="line">    <span class="keyword">if</span> (end &gt; size - <span class="number">1</span>) &#123;</span><br><span class="line">      end = size - <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// invalid or unsatisifiable</span></span><br><span class="line">    <span class="comment">// 如果经过上面处理之后，还有一些无效的情况</span></span><br><span class="line">    <span class="comment">// 如：起始索引大于结束索引，或者开始索引是负数等</span></span><br><span class="line">    <span class="comment">// 那么跳过这些情况</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isNaN</span>(start) || <span class="built_in">isNaN</span>(end) || start &gt; end || start &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add range</span></span><br><span class="line">    ranges.push(&#123;</span><br><span class="line">      start: start,</span><br><span class="line">      end: end</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果最终都没有解析到有效的，那么返回-1</span></span><br><span class="line">  <span class="keyword">if</span> (ranges.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// unsatisifiable</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果传入options.combine，那么先处理索引重叠的情况</span></span><br><span class="line">  <span class="comment">// 否则直接返回</span></span><br><span class="line">  <span class="keyword">return</span> options &amp;&amp; options.combine ? combineRanges(ranges) : ranges</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>处理索引有重叠，合并小的连续的范围：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var range = parse(150, 'bytes=0-4,90-99,5-75,100-199,101-102', &#123; combine: true &#125;)</span></span><br><span class="line"><span class="comment">// assert.strictEqual(range.type, 'bytes')</span></span><br><span class="line"><span class="comment">// assert.strictEqual(range.length, 2)</span></span><br><span class="line"><span class="comment">// assert.deepEqual(range[0], &#123; start: 0, end: 75 &#125;)</span></span><br><span class="line"><span class="comment">// assert.deepEqual(range[1], &#123; start: 90, end: 149 &#125;)</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Combine overlapping &amp; adjacent ranges.</span></span><br><span class="line"><span class="comment"> * @private</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combineRanges</span>(<span class="params">ranges</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// [</span></span><br><span class="line">  <span class="comment">//   &#123; start: 0, end: 4, index: 0 &#125;,</span></span><br><span class="line">  <span class="comment">//   &#123; start: 5, end: 75, index: 2 &#125;,</span></span><br><span class="line">  <span class="comment">//   &#123; start: 90, end: 99, index: 1 &#125;,</span></span><br><span class="line">  <span class="comment">//   &#123; start: 101, end: 102, index: 4 &#125;,</span></span><br><span class="line">  <span class="comment">//   &#123; start: 100, end: 199, index: 3 &#125;,</span></span><br><span class="line">  <span class="comment">// ]</span></span><br><span class="line">  <span class="keyword">var</span> ordered = ranges.map(mapWithIndex).sort(sortByRangeStart)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>, i = <span class="number">1</span>; i &lt; ordered.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> range = ordered[i]</span><br><span class="line">    <span class="keyword">var</span> current = ordered[j]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (range.start &gt; current.end + <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// next range</span></span><br><span class="line">      ordered[++j] = range</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (range.end &gt; current.end) &#123;</span><br><span class="line">      <span class="comment">// extend range</span></span><br><span class="line">      current.end = range.end</span><br><span class="line">      current.index = <span class="built_in">Math</span>.min(current.index, range.index)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// trim ordered array</span></span><br><span class="line">  ordered.length = j + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate combined range</span></span><br><span class="line">  <span class="keyword">var</span> combined = ordered.sort(sortByRangeIndex).map(mapWithoutIndex)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// copy ranges type</span></span><br><span class="line">  combined.type = ranges.type</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> combined</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Range-简介&quot;&gt;&lt;a href=&quot;#Range-简介&quot; class=&quot;headerlink&quot; title=&quot;Range 简介&quot;&gt;&lt;/a&gt;Range 简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;Range&lt;/em&gt;是一个请求首部，告知服务器返回文件的哪
      
    
    </summary>
    
      <category term="http" scheme="https://xxxxxmiss.github.io/categories/http/"/>
    
    
      <category term="http" scheme="https://xxxxxmiss.github.io/tags/http/"/>
    
      <category term="range" scheme="https://xxxxxmiss.github.io/tags/range/"/>
    
  </entry>
  
  <entry>
    <title>http-etag-if-none-match</title>
    <link href="https://xxxxxmiss.github.io/2018/11/19/http-etag-if-none-match/"/>
    <id>https://xxxxxmiss.github.io/2018/11/19/http-etag-if-none-match/</id>
    <published>2018-11-19T12:57:22.000Z</published>
    <updated>2018-11-23T09:21:50.286Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ETag简介"><a href="#ETag简介" class="headerlink" title="ETag简介"></a>ETag简介</h2><blockquote><p>是资源的特定版本的标识符，这可以让缓存更高效，并节省带宽，因为如果内容没有改变，Web服务器不需要发送完整的响应。ETag有强弱之分：</p></blockquote><ul><li><p><code>W/&quot;&lt;etag_value&gt;&quot;</code>: 弱验证器很容易生成，但不利于比较。 强验证器是比较的理想选择，但很难有效地生成。 相同资源的两个弱Etag值可能语义等同，但不是每个字节都相同。</p></li><li><p><code>&quot;&lt;etag_value&gt;&quot;</code>: 没有明确指定生成ETag值的方法。 通常，使用内容的散列。</p></li></ul><h2 id="nodjs-etag模块"><a href="#nodjs-etag模块" class="headerlink" title="nodjs etag模块"></a><a href="https://github.com/jshttp/etag" target="_blank" rel="noopener">nodjs etag模块</a></h2><p>etag(entity, options)</p><blockquote><p>entity: 可以是<code>String</code>, <code>Buffer</code>, <code>fs.Stats</code><br>options.weak: 是否生成弱的etag, 默认为false（即默认生成强的etag），但是如果<code>entity</code>为<code>fs.Stats</code>，那么生成弱的etag。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只列出核心代码，一些对参数的校验啥的已略过</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">etag</span> (<span class="params">entity, options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 判断entity是否为fs.Stats类型</span></span><br><span class="line">  <span class="keyword">var</span> isStats = isstats(entity)</span><br><span class="line">  <span class="keyword">var</span> weak = options &amp;&amp; <span class="keyword">typeof</span> options.weak === <span class="string">'boolean'</span></span><br><span class="line">    ? options.weak</span><br><span class="line">    : isStats</span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate entity tag</span></span><br><span class="line">  <span class="keyword">var</span> tag = isStats</span><br><span class="line">    ? stattag(entity)</span><br><span class="line">    : entitytag(entity)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> weak</span><br><span class="line">    ? <span class="string">'W/'</span> + tag <span class="comment">// 弱etag</span></span><br><span class="line">    : tag</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 弱的etag是根据fs.Stats生成</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stattag</span> (<span class="params">stat</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 得到mtime时间戳的16进制</span></span><br><span class="line">  <span class="keyword">var</span> mtime = stat.mtime.getTime().toString(<span class="number">16</span>)</span><br><span class="line">  <span class="comment">// 得到size的16进制</span></span><br><span class="line">  <span class="keyword">var</span> size = stat.size.toString(<span class="number">16</span>)</span><br><span class="line">  <span class="comment">// 按照规范etag，应该用双引号包裹生成的字符串。</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">'"'</span> + size + <span class="string">'-'</span> + mtime + <span class="string">'"'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 强tag，是将buffer或者字符串进行sha1，</span></span><br><span class="line"><span class="comment">// 在进行base64编码，在截取前27位</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">entitytag</span> (<span class="params">entity</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (entity.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// fast-path empty</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'"0-2jmj7l5rSw0yVb/vlWAYkK/YBwk"'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// compute hash of entity</span></span><br><span class="line">  <span class="keyword">var</span> hash = crypto</span><br><span class="line">    .createHash(<span class="string">'sha1'</span>)</span><br><span class="line">    .update(entity, <span class="string">'utf8'</span>)</span><br><span class="line">    .digest(<span class="string">'base64'</span>)</span><br><span class="line">    .substring(<span class="number">0</span>, <span class="number">27</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取字符串或者buffer的字节数</span></span><br><span class="line">  <span class="keyword">var</span> len = <span class="keyword">typeof</span> entity === <span class="string">'string'</span></span><br><span class="line">    ? Buffer.byteLength(entity, <span class="string">'utf8'</span>)</span><br><span class="line">    : entity.length</span><br><span class="line"></span><br><span class="line">  <span class="comment">// " + 字节数的16进制 + 连接符 + hash + " =&gt; 强etag</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">'"'</span> + len.toString(<span class="number">16</span>) + <span class="string">'-'</span> + hash + <span class="string">'"'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="http缓存机制"><a href="#http缓存机制" class="headerlink" title="http缓存机制"></a>http缓存机制</h2><blockquote><p>主要由以下请求头和响应头控制：</p></blockquote><ul><li>Expires</li><li>Cache-Control</li><li>Last-Modified</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Match" target="_blank" rel="noopener">If-Match</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-None-Match" target="_blank" rel="noopener">If-None-Match</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Modified-Since" target="_blank" rel="noopener">If-Modified-Since</a></li><li><a href="(https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Unmodified-Since">If-Unmodified-Since</a></li><li>Etag</li></ul><h3 id="Cache-Control易混淆点解释"><a href="#Cache-Control易混淆点解释" class="headerlink" title="Cache-Control易混淆点解释"></a>Cache-Control易混淆点解释</h3><blockquote><p>单个的，常用的属性解释：</p></blockquote><ul><li><p>max-age：用来设置资源可以被缓存多长时间，单位为秒；</p></li><li><p>s-maxage：和max-age是一样的，不过它只针对代理服务器缓存而言；</p></li><li><p>public：指示响应可被任何缓存区缓存（服务器，代理，客户端）；</p></li><li><p>private：只能针对个人用户，而不能被代理服务器缓存；</p></li><li><p>no-cache：强制客户端直接向服务器发送请求,也就是说每次请求都必须向服务器发送。服务器接收到请求，然后判断资源是否变更，是则返回新内容，否则返回304，未变更。这个很容易让人产生误解，使人误以为是响应不被缓存。实际上Cache-Control: no-cache是会被缓存的，只不过每次在向客户端（浏览器）提供响应数据时，缓存都要向服务器评估缓存响应的有效性。</p></li><li><p>no-store：禁止一切缓存（这个才是响应不被缓存的意思）。</p></li></ul><blockquote><p>组合属性解释：</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cache</span>-control:<span class="keyword">private</span>, <span class="keyword">no</span>-<span class="keyword">cache</span>, <span class="keyword">no</span>-<span class="keyword">store</span>, must-revalidate</span><br></pre></td></tr></table></figure><p>很多情况下，你会看到如上的组合。其实上面的组合是冗余的，但是它可能并不是原始服务器设置的，而是经过多个设备，最终组合成上面的形式。<br>我们可以根据上面<a href="#Cache-Control易混淆点解释">单个属性</a>的解释，可以得出上面的组合其实等同于如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cache</span>-control:<span class="keyword">no</span>-<span class="keyword">store</span></span><br></pre></td></tr></table></figure><p>也就是当出现多个属性组合时，要根据单个属性的定义得出最终的值，并不是所有的值都生效。</p><p><a href="https://tools.ietf.org/html/rfc7234#section-4.2.1" target="_blank" rel="noopener">More</a></p><h2 id="常用条件请求的搭配之一"><a href="#常用条件请求的搭配之一" class="headerlink" title="常用条件请求的搭配之一"></a>常用条件请求的搭配之一</h2><blockquote><p><code>ETag</code>和<code>If-None-Math</code>，原理解释如下：</p></blockquote><ol><li>第一次请求由服务端生成etag，并随响应头一起返回给客户端</li><li>当你第二次发起<em>同一个请求</em>时，客户端会发送一个<code>If-None-Match</code>的请求头，该请求头的值就是etag的值。然后服务器会将客户端发送过来的etag与自己保存的etag做比较。如果是一样的，那么就返回<code>304</code>，表明客户端可以继续使用本地缓存。否则就返回<code>200</code>，客户端重新解析服务器返回的数据。</li></ol><h3 id="演示demo"><a href="#演示demo" class="headerlink" title="演示demo"></a>演示demo</h3><h2 id="文件结构："><a href="#文件结构：" class="headerlink" title="文件结构："></a>文件结构：</h2><p>|-rxjs<br>|——index.html<br>|-server.js<br>|-client.html</p><p>客户端：<br>client.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://127.0.0.1:3000"</span>&gt;</span>测试链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>服务端<br>server.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> serveStatic = <span class="built_in">require</span>(<span class="string">'serve-static'</span>)</span><br><span class="line"><span class="keyword">const</span> finalhandler = <span class="built_in">require</span>(<span class="string">'finalhandler'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// rxjs是和该脚本放在同一个目录下的一个文件夹</span></span><br><span class="line"><span class="comment">// 可以在rxjs文件夹下放置一个index.html</span></span><br><span class="line"><span class="comment">// 修改rxjs/index.html中的内容，然后观察network中etag和if-none-match的变化以及stausCode的变化</span></span><br><span class="line"><span class="keyword">const</span> serve = serveStatic(<span class="string">'rxjs'</span>)</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  serve(req, res, finalhandler(req, res))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Server is listening port: 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h2 id="Last-Modified-amp-If-Modified-Since"><a href="#Last-Modified-amp-If-Modified-Since" class="headerlink" title="Last-Modified &amp; If-Modified-Since"></a>Last-Modified &amp; If-Modified-Since</h2><p>Last-Modified与Etag类似。不过Last-Modified表示响应资源在服务器最后修改时间而已。与Etag相比，不足为：</p><ul><li><p>Last-Modified标注的最后修改只能精确到秒级，如果某些文件在1秒钟以内，被修改多次的话，它将不能准确标注文件的修改时间；</p></li><li><p>如果某些文件会被定期生成，当有时内容并没有任何变化，但Last-Modified却改变了，导致文件没法使用缓存；</p></li><li><p>有可能存在服务器没有准确获取文件修改时间，或者与代理服务器时间不一致等情形。</p></li></ul><p>然而，Etag是服务器自动生成或者由开发者生成的对应资源在服务器端的唯一标识符，能够更加准确的控制缓存。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ETag简介&quot;&gt;&lt;a href=&quot;#ETag简介&quot; class=&quot;headerlink&quot; title=&quot;ETag简介&quot;&gt;&lt;/a&gt;ETag简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;是资源的特定版本的标识符，这可以让缓存更高效，并节省带宽，因为如果内容没有改变，W
      
    
    </summary>
    
      <category term="http" scheme="https://xxxxxmiss.github.io/categories/http/"/>
    
    
      <category term="http" scheme="https://xxxxxmiss.github.io/tags/http/"/>
    
      <category term="etag" scheme="https://xxxxxmiss.github.io/tags/etag/"/>
    
      <category term="if-none-match" scheme="https://xxxxxmiss.github.io/tags/if-none-match/"/>
    
  </entry>
  
  <entry>
    <title>http-redirection</title>
    <link href="https://xxxxxmiss.github.io/2018/11/18/http-redirection/"/>
    <id>https://xxxxxmiss.github.io/2018/11/18/http-redirection/</id>
    <published>2018-11-18T06:51:13.000Z</published>
    <updated>2018-11-18T08:33:56.933Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Permanent-Redirection-永久重定向"><a href="#Permanent-Redirection-永久重定向" class="headerlink" title="Permanent Redirection(永久重定向)"></a>Permanent Redirection(永久重定向)</h2><table><thead><tr><th>statusCode</th><th>含义</th><th>处理方法</th><th>场景</th></tr></thead><tbody><tr><td>301</td><td>Moved Permanently</td><td>GET 方法不会发生变更，其他方法有可能会变更为 GET 方法</td><td>-</td></tr><tr><td>308</td><td>Permanent Redirect</td><td>方法和消息主体都不发生变化</td><td>-</td></tr></tbody></table><h2 id="Temporary-Redirection-临时重定向"><a href="#Temporary-Redirection-临时重定向" class="headerlink" title="Temporary Redirection(临时重定向)"></a>Temporary Redirection(临时重定向)</h2><table><thead><tr><th>statusCode</th><th>含义</th><th>处理方法</th><th>场景</th></tr></thead><tbody><tr><td>302</td><td>Found</td><td>GET 方法不会发生变更，其他方法有可能会变更为 GET 方法</td><td>-</td></tr><tr><td>303</td><td>See Other</td><td>GET 方法不会发生变更，其他方法会变更为 GET 方法（消息主体会丢失)</td><td>-</td></tr><tr><td>307</td><td>Temporary Redirect</td><td>方法和消息主体都不发生变化</td><td>-</td></tr></tbody></table><h2 id="Special-Redirection-特殊重定向"><a href="#Special-Redirection-特殊重定向" class="headerlink" title="Special Redirection(特殊重定向)"></a>Special Redirection(特殊重定向)</h2><table><thead><tr><th>statusCode</th><th>含义</th><th>场景</th></tr></thead><tbody><tr><td>300</td><td>Multiple Choice</td><td>不会太多：所有的选项在消息主体的 HTML 页面中列出。也可以返回 200 OK 状态码。</td></tr><tr><td>304</td><td>Not Modified</td><td>缓存刷新：该状态码表示缓存值依然有效，可以使用。</td></tr></tbody></table><h2 id="重定向的3种方法"><a href="#重定向的3种方法" class="headerlink" title="重定向的3种方法"></a>重定向的3种方法</h2><blockquote><p>当这3种方式同时存在时，优先级由高到低：http &gt; html meta &gt; js。</p></blockquote><ul><li>使用http协议重定向（上面介绍的3种重定向）</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res.statusCode = <span class="number">307</span></span><br><span class="line">res.setHeader(<span class="string">'Location'</span>, <span class="string">'/doc-new'</span>)</span><br></pre></td></tr></table></figure><ul><li>使用html<code>meta</code>标签</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"0;URL=http://www.example.com/"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><code>content</code> 属性的值开头是一个数字，指示浏览器在等待该数字表示的秒数之后再进行跳转。建议始终将其设置为 0 来获取更好的可访问性。</p></blockquote><ul><li>使用js</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.location.href = <span class="string">'http://www.example.com/'</span></span><br></pre></td></tr></table></figure><h2 id="对于不安全请求的临时响应节"><a href="#对于不安全请求的临时响应节" class="headerlink" title="对于不安全请求的临时响应节"></a>对于不安全请求的临时响应节</h2><p>不安全请求会修改服务器端的状态，应该避免用户无意的重复操作。一般地，你并不想要你的用户重复发送 <code>PUT</code>、<code>POST</code> 或 <code>DELETE</code> 请求。假如你仅仅为该类请求返回响应的话，简单地点击刷新按钮就会（可能会有一个确认信息）导致请求的重复发送。</p><p>在这种情况下，服务器可以返回一个 303 (See Other) 响应，其中含有合适的响应信息。如果刷新按钮被点击的话，只会导致该页面被刷新，而不会重复提交不安全的请求。</p><h2 id="对于耗时请求的临时响应节"><a href="#对于耗时请求的临时响应节" class="headerlink" title="对于耗时请求的临时响应节"></a>对于耗时请求的临时响应节</h2><p>一些请求的处理会需要比较长的时间，比如有时候 DELETE 请求会被安排为稍后处理。在这种情况下，会返回一个 303 (See Other)  重定向响应，该响应链接到一个页面，表示请求的操作已经被列入计划，并且最终会通知用户操作的进展情况，或者允许用户将其取消。</p><h2 id="Nginx中配置重定向"><a href="#Nginx中配置重定向" class="headerlink" title="Nginx中配置重定向"></a>Nginx中配置重定向</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> example.com;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">301</span> <span class="variable">$schema</span>://www.example.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以使用 rewrite 指令来针对一个文件目录或者一部分页面应用重定向设置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/images/(.*)$</span> http://images.example.com/<span class="variable">$1</span> <span class="literal">redirect</span>;</span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/images/(.*)$</span> http://images.example.com/<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Permanent-Redirection-永久重定向&quot;&gt;&lt;a href=&quot;#Permanent-Redirection-永久重定向&quot; class=&quot;headerlink&quot; title=&quot;Permanent Redirection(永久重定向)&quot;&gt;&lt;/a&gt;Perm
      
    
    </summary>
    
      <category term="http" scheme="https://xxxxxmiss.github.io/categories/http/"/>
    
    
      <category term="http" scheme="https://xxxxxmiss.github.io/tags/http/"/>
    
      <category term="redirection" scheme="https://xxxxxmiss.github.io/tags/redirection/"/>
    
  </entry>
  
  <entry>
    <title>platform-compatibility</title>
    <link href="https://xxxxxmiss.github.io/2018/11/13/platform-compatibility/"/>
    <id>https://xxxxxmiss.github.io/2018/11/13/platform-compatibility/</id>
    <published>2018-11-13T03:40:24.000Z</published>
    <updated>2018-11-16T03:49:51.341Z</updated>
    
    <content type="html"><![CDATA[<h2 id="new-Date"><a href="#new-Date" class="headerlink" title="new Date()"></a>new Date()</h2><blockquote><p>如果使用格式化字符串的形式，一般有如下几种形式：</p></blockquote><table><thead><tr><th></th><th>yyyy-MM-dd</th><th>yyyy/MM/dd</th><th>yyyy.MM.dd</th></tr></thead><tbody><tr><td>IOS</td><td>✅</td><td>✅</td><td>❎</td></tr><tr><td>Android</td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table><p>所以对于<code>yyyy.MM.dd</code>的形式，一般转化成前面2种形式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dateStr.replace(<span class="string">'.'</span>, <span class="string">'/'</span>)</span><br></pre></td></tr></table></figure><p>Note: 经测试发现，如果少了<em>日</em>的字符，也会出现兼容性问题。<br>就比如这种<code>yyyy/MM</code>, 所以为了安全起见，最好这样转化下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="regexp">/^[\d]&#123;2,4&#125;[-/.]\d&#123;1,2&#125;$/</span>.test(dateStr)) &#123;</span><br><span class="line">  dateStr.replace(<span class="regexp">/[.-]/g</span>, <span class="string">'/'</span>) + <span class="string">'/01'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;new-Date&quot;&gt;&lt;a href=&quot;#new-Date&quot; class=&quot;headerlink&quot; title=&quot;new Date()&quot;&gt;&lt;/a&gt;new Date()&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;如果使用格式化字符串的形式，一般有如下几种形式：&lt;/p&gt;

      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>share-miniapp</title>
    <link href="https://xxxxxmiss.github.io/2018/10/20/share-miniapp/"/>
    <id>https://xxxxxmiss.github.io/2018/10/20/share-miniapp/</id>
    <published>2018-10-20T06:22:57.000Z</published>
    <updated>2018-11-14T09:07:01.615Z</updated>
    
    <content type="html"><![CDATA[<h2 id="小程序架构"><a href="#小程序架构" class="headerlink" title="小程序架构"></a><a href="https://www.jianshu.com/p/4e8ed26d3b7a" target="_blank" rel="noopener">小程序架构</a></h2><img src="/2018/10/20/share-miniapp/miniapp-structure.png" title="小程序架构"><h2 id="JSBridge"><a href="#JSBridge" class="headerlink" title="JSBridge"></a>JSBridge</h2><blockquote><p>JavaScript 是运行在一个单独的 JS Context 中（例如，WebView 的 Webkit 引擎、JSCore）。由于这些 Context 与原生运行环境的天然隔离，我们可以将这种情况与 RPC（Remote Procedure Call，远程过程调用）通信进行类比，将 Native 与 JavaScript 的每次互相调用看做一次 RPC 调用。<br>在 JSBridge 的设计中，可以把前端看做 RPC 的客户端，把 Native 端看做 RPC 的服务器端，从而 JSBridge 要实现的主要逻辑就出现了：通信调用（Native 与 JS 通信） 和 句柄解析调用。（如果你是个前端，而且并不熟悉 RPC 的话，你也可以把这个流程类比成 <a href="#JSONP实现原理">JSONP</a> 的流程）</p></blockquote><img src="/2018/10/20/share-miniapp/jsbridge.png" title="js桥接"><p>JavaScript 调用 Native 的方式，主要有两种：注入 API 和 拦截 URL SCHEME。</p><h3 id="注入API"><a href="#注入API" class="headerlink" title="注入API"></a>注入API</h3><p>注入 API 方式的主要原理是，通过 WebView 提供的接口，向 JavaScript 的 Context（window）中注入对象或者方法，让 JavaScript 调用时，直接执行相应的 Native 代码逻辑，达到 JavaScript 调用 Native 的目的。</p><p>IOS:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JSContext *context = [uiWebView valueForKeyPath:<span class="string">@"documentView.webView.mainFrame.javaScriptContext"</span>];</span><br><span class="line"></span><br><span class="line">context[<span class="string">@"postBridgeMessage"</span>] = ^(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSArray</span> *&gt; *calls) &#123;</span><br><span class="line">    <span class="comment">// Native 逻辑</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>前端调用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.postBridgeMessage(message);</span><br></pre></td></tr></table></figure><p>Android<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaScriptInterfaceDemoActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> WebView Wv;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">      Wv = (WebView)findViewById(R.id.webView);     </span><br><span class="line">      <span class="keyword">final</span> JavaScriptInterface myJavaScriptInterface = <span class="keyword">new</span> JavaScriptInterface(<span class="keyword">this</span>);     </span><br><span class="line"></span><br><span class="line">      Wv.getSettings().setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line">      Wv.addJavascriptInterface(myJavaScriptInterface, <span class="string">"nativeBridge"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// TODO 显示 WebView</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaScriptInterface</span> </span>&#123;</span><br><span class="line">        Context mContext;</span><br><span class="line"></span><br><span class="line">        JavaScriptInterface(Context c) &#123;</span><br><span class="line">            mContext = c;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postMessage</span><span class="params">(String webMessage)</span></span>&#123;    </span><br><span class="line">            <span class="comment">// Native 逻辑</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>前端调用：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.nativeBridge.postMessage(message);</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">    android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">    android:orientation=<span class="string">"vertical"</span> &gt;</span><br><span class="line">    &lt;WebView</span><br><span class="line">      android:id=<span class="string">"@+id/webView"</span></span><br><span class="line">      android:layout_width=<span class="string">"fill_parent"</span></span><br><span class="line">      android:layout_height=<span class="string">"fill_parent"</span></span><br><span class="line">  /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure><h3 id="拦截URL-SCHEMA"><a href="#拦截URL-SCHEMA" class="headerlink" title="拦截URL SCHEMA"></a>拦截URL SCHEMA</h3><blockquote><p>URL SCHEME：URL SCHEME是一种类似于url的链接，是为了方便app直接互相调用设计的，形式和普通的 url 近似，主要区别是 protocol 和 host 一般是自定义的，例如: qunarhy://hy/url?url=ymfe.tech，protocol 是 qunarhy，host 则是 hy。<br>拦截 URL SCHEME 的主要流程是：Web 端通过某种方式（例如 iframe.src）发送 URL Scheme 请求，之后 Native 拦截到请求并根据 URL SCHEME（包括所带的参数）进行相关操作。</p></blockquote><h3 id="JSBridge雏形"><a href="#JSBridge雏形" class="headerlink" title="JSBridge雏形"></a>JSBridge雏形</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> id = <span class="number">0</span>,</span><br><span class="line">        callbacks = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.JSBridge = &#123;</span><br><span class="line">        <span class="comment">// 调用 Native</span></span><br><span class="line">        invoke: <span class="function"><span class="keyword">function</span>(<span class="params">bridgeName, callback, data</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 判断环境，获取不同的 nativeBridge</span></span><br><span class="line">            <span class="keyword">var</span> thisId = id ++; <span class="comment">// 获取唯一 id</span></span><br><span class="line">            callbacks[thisId] = callback; <span class="comment">// 存储 Callback</span></span><br><span class="line">            nativeBridge.postMessage(&#123;</span><br><span class="line">                bridgeName: bridgeName,</span><br><span class="line">                data: data || &#123;&#125;,</span><br><span class="line">                callbackId: thisId <span class="comment">// 传到 Native 端</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        receiveMessage: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> bridgeName = msg.bridgeName,</span><br><span class="line">                data = msg.data || &#123;&#125;,</span><br><span class="line">                callbackId = msg.callbackId; <span class="comment">// Native 将 callbackId 原封不动传回</span></span><br><span class="line">            <span class="comment">// 具体逻辑</span></span><br><span class="line">            <span class="comment">// bridgeName 和 callbackId 不会同时存在</span></span><br><span class="line">            <span class="keyword">if</span> (callbackId) &#123;</span><br><span class="line">                <span class="keyword">if</span> (callbacks[callbackId]) &#123; <span class="comment">// 找到相应句柄</span></span><br><span class="line">                    callbacks[callbackId](msg.data); <span class="comment">// 执行调用</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; elseif (bridgeName) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h2 id="JSONP实现原理"><a href="#JSONP实现原理" class="headerlink" title="JSONP实现原理"></a>JSONP实现原理</h2><blockquote><p>听者作答</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>._callback = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// your logic</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br><span class="line">script.src = <span class="string">`<span class="subst">$&#123;url&#125;</span>&amp;_callback=_callback`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><h2 id="JavaScript-与-Objective-C-交互"><a href="#JavaScript-与-Objective-C-交互" class="headerlink" title="JavaScript 与 Objective-C 交互"></a>JavaScript 与 Objective-C 交互</h2><p>主要通过以下2种方式：</p><ul><li>Block: 第一种方式是使用block，block也可以称作闭包和匿名函数，使用block可以很方便的将OC中的单个方法暴露给JS调用，具体实现我们稍后再说。</li><li>JSExport 协议: 第二种方式，是使用JSExport协议，可以将OC的中某个对象直接暴露给JS使用，而且在JS中使用就像调用JS的对象一样自然。</li></ul><p>栗子：通过Block形式</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">context[<span class="string">@"makeNSColor"</span>] = ^(<span class="built_in">NSDictionary</span> *rgb)&#123;</span><br><span class="line">  <span class="keyword">float</span> r = [colors[<span class="string">@"red"</span>] floatValue];</span><br><span class="line">  <span class="keyword">float</span> g = [colors[<span class="string">@"green"</span>] floatValue];</span><br><span class="line">  <span class="keyword">float</span> b = [colors[<span class="string">@"blue"</span>] floatValue];</span><br><span class="line">  <span class="keyword">return</span> [<span class="built_in">NSColor</span> colorWithRed:(r / <span class="number">255.0</span>)</span><br><span class="line">    green: (g / <span class="number">255.0</span>f)</span><br><span class="line">    blue: (b / <span class="number">255.0</span>f)</span><br><span class="line">    alpha: <span class="number">1.0</span></span><br><span class="line">  ];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> colorForWord = <span class="function"><span class="keyword">function</span> (<span class="params">word</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!colorMap(word)) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> makeNSColor(colorMap(word))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> colorMap = &#123;</span><br><span class="line">  orange: &#123; <span class="attr">red</span>: <span class="number">255</span>, <span class="attr">green</span>: <span class="number">255</span>, <span class="attr">blue</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  cyan: &#123; <span class="attr">red</span>: <span class="number">255</span>, <span class="attr">green</span>: <span class="number">155</span>, <span class="attr">blue</span>: <span class="number">0</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2018/10/20/share-miniapp/js-oc-call.png" title="js和oc的相互调用"><img src="/2018/10/20/share-miniapp/js-oc-type.png" title="js和oc的类型对应关系"><h2 id="原生小程序开发痛点："><a href="#原生小程序开发痛点：" class="headerlink" title="原生小程序开发痛点："></a>原生小程序开发痛点：</h2><ul><li>仅支持大部分es2015语法，无法使用es2016+语法（async/await等）</li><li>对于背景图片，无法使用本地路径，需要上传图片至服务器以使用远程地址或者转化为base64编码</li><li>对于直接使用iconfont，需要转换成base64编码</li><li>不支持css预处理器（less, scss, stylus等）</li><li>无法使用eslint等代码检查工具</li><li>对于第三方依赖，需要手动拷贝源代码到项目中，无法直接使用npm包</li><li>…</li><li>总结起来就是无法<em>工程化</em></li></ul><h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><ul><li>代码压缩</li><li>及时清理无用代码和资源文件（这条已经变得不是很重要了，因为现在没用到的资源并不会被打包）</li><li>减少代码包中的图片等资源文件的大小和数量</li><li>提前请求，但是请求的数据不立即发送到视图层渲染，而是在合适的时机在渲染（<code>setData</code>）</li><li>缓存，利用 storage API 对异步请求数据进行缓存，二次启动时先利用缓存数据渲染页面，在进行后台更新</li><li>分包加载</li></ul><h3 id="分包优点以及限制"><a href="#分包优点以及限制" class="headerlink" title="分包优点以及限制"></a>分包优点以及限制</h3><img src="/2018/10/20/share-miniapp/sub-package.png" title="分包加载"><p>优点：</p><blockquote><p>对开发者而言，能使小程序有更大的代码体积，承载更多的功能与服务<br>对用户而言，可以更快地打开小程序，同时在不影响启动速度前提下使用更多功能</p></blockquote><p>限制：</p><blockquote><p>整个小程序所有分包大小不超过 8M<br>单个分包/主包大小不能超过 2M</p></blockquote><h3 id="避免不当使用setData"><a href="#避免不当使用setData" class="headerlink" title="避免不当使用setData"></a>避免不当使用setData</h3><img src="/2018/10/20/share-miniapp/miniapp-render.png" title="小程序的渲染机制"><ul><li>使用 data 在方法间共享数据，可能增加 setData 传输的数据量。。data 应仅包括与页面渲染相关的数据。</li><li>使用 setData 传输大量数据，<strong>通讯耗时与数据正相关，页面更新延迟可能造成页面更新开销增加。</strong>仅传输页面中发生变化的数据，使用 setData 的特殊 key 实现局部更新。</li><li>短时间内频繁调用 setData，<strong>操作卡顿，交互延迟，阻塞通信，页面渲染延迟。</strong>避免不必要的 setData，对连续的setData调用进行合并。</li><li>在后台页面进行 setData，<strong>抢占前台页面的渲染资源。</strong>页面切入后台后的 setData 调用，延迟到页面重新展示时执行。</li></ul><h3 id="避免不当使用onPageScroll"><a href="#避免不当使用onPageScroll" class="headerlink" title="避免不当使用onPageScroll"></a>避免不当使用onPageScroll</h3><ul><li>只在有必要的时候监听 pageScroll 事件。不监听，则不会派发。</li><li>避免在 onPageScroll 中执行复杂逻辑</li><li>避免在 onPageScroll 中频繁调用 setData</li><li>避免滑动时频繁查询节点信息（SelectQuery）用以判断是否显示，部分场景建议使用节点布局橡胶状态监听（inersectionObserver）替代</li></ul><h2 id="小程序开发框架比较"><a href="#小程序开发框架比较" class="headerlink" title="小程序开发框架比较"></a>小程序开发框架比较</h2><img src="/2018/10/20/share-miniapp/framework-comparison.png" title="小程序开发框架比较"><h2 id="各大框架的转化原理（以taro为例）"><a href="#各大框架的转化原理（以taro为例）" class="headerlink" title="各大框架的转化原理（以taro为例）"></a>各大框架的转化原理（以taro为例）</h2><img src="/2018/10/20/share-miniapp/taro-build.png" title="taro转化原理"><h2 id="各大框架相关链接"><a href="#各大框架相关链接" class="headerlink" title="各大框架相关链接"></a>各大框架相关链接</h2><h3 id="Taro"><a href="#Taro" class="headerlink" title="Taro"></a><a href="https://nervjs.github.io/taro/doc/router.html" target="_blank" rel="noopener">Taro</a></h3><blockquote><p><a href="https://github.com/NervJS/taro/issues" target="_blank" rel="noopener">官方仓库</a></p></blockquote><ul><li><a href="https://aotu.io/notes/2018/06/07/Taro/index.html" target="_blank" rel="noopener">Related</a></li></ul><h3 id="nanachi"><a href="#nanachi" class="headerlink" title="nanachi"></a><a href="https://rubylouvre.github.io/nanachi/index.html" target="_blank" rel="noopener">nanachi</a></h3><blockquote><p><a href="https://github.com/RubyLouvre/anu/tree/master/packages/cli" target="_blank" rel="noopener">官方仓库</a></p></blockquote><h3 id="mpvue"><a href="#mpvue" class="headerlink" title="mpvue"></a><a href="http://mpvue.com/" target="_blank" rel="noopener">mpvue</a></h3><blockquote><p><a href="https://github.com/Meituan-Dianping/mpvue/issues" target="_blank" rel="noopener">官方仓库</a></p></blockquote><h3 id="megalo"><a href="#megalo" class="headerlink" title="megalo"></a><a href="https://kaola-fed.github.io/megalo-docs/#/" target="_blank" rel="noopener">megalo</a></h3><blockquote><p><a href="https://github.com/kaola-fed/megalo/issues" target="_blank" rel="noopener">官方仓库</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;小程序架构&quot;&gt;&lt;a href=&quot;#小程序架构&quot; class=&quot;headerlink&quot; title=&quot;小程序架构&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.jianshu.com/p/4e8ed26d3b7a&quot; target=&quot;_blank&quot; rel=&quot;n
      
    
    </summary>
    
      <category term="前端" scheme="https://xxxxxmiss.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="小程序" scheme="https://xxxxxmiss.github.io/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
      <category term="Hybrid开发" scheme="https://xxxxxmiss.github.io/tags/Hybrid%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>css-border-radius</title>
    <link href="https://xxxxxmiss.github.io/2018/04/02/css-border-radius/"/>
    <id>https://xxxxxmiss.github.io/2018/04/02/css-border-radius/</id>
    <published>2018-04-02T07:30:11.000Z</published>
    <updated>2018-04-02T07:37:02.834Z</updated>
    
    <content type="html"><![CDATA[<h2 id="border-radius"><a href="#border-radius" class="headerlink" title="border-radius"></a>border-radius</h2><blockquote><p>如果一个父元素设置<code>border-radius</code>,子元素占据该父元素的<code>100%</code>,<br>但是该子元素并未设置<code>border-radius</code>,那么父元素的<code>border-radius</code>会被盖住（也就是说视觉上根本就跟父元素没有设置 <code>border-radius</code>一样）</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;border-radius&quot;&gt;&lt;a href=&quot;#border-radius&quot; class=&quot;headerlink&quot; title=&quot;border-radius&quot;&gt;&lt;/a&gt;border-radius&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;如果一个父元素设置&lt;cod
      
    
    </summary>
    
      <category term="front-end" scheme="https://xxxxxmiss.github.io/categories/front-end/"/>
    
    
      <category term="css" scheme="https://xxxxxmiss.github.io/tags/css/"/>
    
      <category term="border-radius" scheme="https://xxxxxmiss.github.io/tags/border-radius/"/>
    
  </entry>
  
  <entry>
    <title>代码规范</title>
    <link href="https://xxxxxmiss.github.io/2018/03/16/git-commit-rules/"/>
    <id>https://xxxxxmiss.github.io/2018/03/16/git-commit-rules/</id>
    <published>2018-03-16T08:21:48.000Z</published>
    <updated>2018-12-12T09:20:24.650Z</updated>
    
    <content type="html"><![CDATA[<h2 id="git-日志提交规范"><a href="#git-日志提交规范" class="headerlink" title="git 日志提交规范"></a>git 日志提交规范</h2><blockquote><p>格式如下：</p></blockquote><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">type</span>&gt;[<span class="keyword">optional</span> scope]: &lt;description&gt;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">optional</span> body]</span><br><span class="line"></span><br><span class="line">[<span class="keyword">optional</span> footer]</span><br></pre></td></tr></table></figure><h3 id="fix-bug"><a href="#fix-bug" class="headerlink" title="fix(:bug:)"></a>fix(:bug:)</h3><blockquote><p>修复问题，对应<code>semver patch</code><br>fix: named slots for nested functional components</p><p>指定具体的模块，功能等</p></blockquote><ul><li>fix(core)</li><li>fix(ssr)</li><li>fix(model)</li><li>fix(keep-alive)</li></ul><h3 id="feat-sparkles"><a href="#feat-sparkles" class="headerlink" title="feat(:sparkles:)"></a>feat(:sparkles:)</h3><blockquote><p>增加新的特征，功能，对应<code>semver minor</code><br>feat(weex): support sending style sheets and class list to native</p></blockquote><h3 id="BREAKING-CHANGE"><a href="#BREAKING-CHANGE" class="headerlink" title="BREAKING CHANGE"></a>BREAKING CHANGE</h3><blockquote><p>内容发生重大改变，对应<code>semver major</code><br>BREAKING CHANGE: environment variables now take precedence over config files</p></blockquote><h3 id="build"><a href="#build" class="headerlink" title="build"></a>build</h3><blockquote><p>构建版本<br>build: release 2.5.15</p></blockquote><h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><blockquote><p>测试相关<br>test(vdom): add test case for #7786 (#7793)</p></blockquote><h3 id="types"><a href="#types" class="headerlink" title="types"></a>types</h3><blockquote><p>当使用<code>type script</code>的时候，如果修改的内容和 types 相关。<br>types: add Fragment in RenderState typing (#7802)</p></blockquote><h3 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h3><blockquote><p>有关工作流的修改<br>workflow: specify e2e env when releasing<br>workflow: remove setup script</p></blockquote><h3 id="chore"><a href="#chore" class="headerlink" title="chore"></a>chore</h3><blockquote><p>一些杂活，比如更新赞助者，重新组织代码贡献者<br>chore: coverage<br>chore: update sponsors<br>chore: re-organize backers.md</p></blockquote><h3 id="refactor"><a href="#refactor" class="headerlink" title="refactor"></a>refactor</h3><blockquote><p>重构代码<br>refactor: observerState</p><p>重构具体的模块<br>refactor(core): remove unnecessary switch case (#5971)</p></blockquote><h3 id="docs-memo"><a href="#docs-memo" class="headerlink" title="docs(:memo:)"></a>docs(:memo:)</h3><blockquote><p>有关文档的修改<br>docs: update Angular’s commit convention link (#7666)</p></blockquote><h3 id="ci"><a href="#ci" class="headerlink" title="ci"></a>ci</h3><blockquote><p>相关工具的修改，比如<code>vue-cli</code><br>ci: use latest version of codecov binary (#7665)</p></blockquote><h3 id="polish"><a href="#polish" class="headerlink" title="polish"></a>polish</h3><blockquote><p>美化代码<br>polish: raise warning when Vue.set/delete is called on invalid values</p></blockquote><h3 id="revert"><a href="#revert" class="headerlink" title="revert"></a>revert</h3><blockquote><p>版本回退<br>revert(weex): remove the “receiveTasks” api and support component hook</p></blockquote><h3 id="perf-zap"><a href="#perf-zap" class="headerlink" title="perf(:zap:)"></a>perf(:zap:)</h3><blockquote><p>优化性能<br>perf(v-model): tweak setSelected</p></blockquote><p><a href="https://github.com/conventional-changelog/conventional-changelog" target="_blank" rel="noopener">Conventional Changelog Ecosystem</a><br><a href="https://semver.org/#spec-item-9" target="_blank" rel="noopener">semantic versioning</a><br><a href="https://conventionalcommits.org/" target="_blank" rel="noopener">git conventional commits</a><br><a href="https://www.webpagefx.com/tools/emoji-cheat-sheet/" target="_blank" rel="noopener">git emojis</a></p><h2 id="使用commitlint校验本地提交信息"><a href="#使用commitlint校验本地提交信息" class="headerlink" title="使用commitlint校验本地提交信息"></a>使用<code>commitlint</code>校验本地提交信息</h2><p>安装包</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">npm</span> i @commitlint/cli @commitlint/config-conventional husky --save-dev</span><br></pre></td></tr></table></figure><p>在项目的根目录下新建<code>commitlint.config.js</code></p><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span>.exports = &#123;<span class="keyword">extends</span>: [<span class="string">'@commitlint/config-conventional'</span>]&#125;</span><br></pre></td></tr></table></figure><p>在<code>scripts</code>中添加如下<code>script</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"commitmsg"</span>: <span class="string">"commitlint -e $GIT_PARAMS"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="使用commitizen交互式窗口生成约定的提交信息"><a href="#使用commitizen交互式窗口生成约定的提交信息" class="headerlink" title="使用commitizen交互式窗口生成约定的提交信息"></a>使用<code>commitizen</code>交互式窗口生成约定的提交信息</h2><h3 id="作为项目依赖安装使用"><a href="#作为项目依赖安装使用" class="headerlink" title="作为项目依赖安装使用"></a>作为项目依赖安装使用</h3><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i commitizen cz-conventional-changelog --<span class="built_in">save</span>-<span class="built_in">dev</span></span><br></pre></td></tr></table></figure><p>package.json 配置</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"commit"</span>: <span class="string">"git-cz"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"config"</span>: &#123;</span><br><span class="line">    <span class="attr">"commitizen"</span>: &#123;</span><br><span class="line">      <span class="attr">"path"</span>: <span class="string">"cz-conventional-changelog"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后每次提交的时候，使用<code>npm run commit</code>代替<code>git commit</code>。</p><h3 id="作为全局安装使用"><a href="#作为全局安装使用" class="headerlink" title="作为全局安装使用"></a>作为全局安装使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g commitizen cz-conventional-changelog</span><br></pre></td></tr></table></figure><p>创建 commitizen 配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'&#123; "path": "cz-conventional-changelog" &#125;'</span> &gt; ~/.czrc</span><br></pre></td></tr></table></figure><p>现在每次提交的时候就可以使用<code>git cz</code>代替<code>git commit</code>。<br><code>git cz</code><strong>支持和</strong><code>git commit</code><strong>一样的选项，如：git cz -a</strong>。</p><h2 id="自定义-commit-校验"><a href="#自定义-commit-校验" class="headerlink" title="自定义 commit 校验"></a>自定义 commit 校验</h2><p>verify-commit-msg.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>)</span><br><span class="line"><span class="keyword">const</span> msgPath = process.env.GIT_PARAMS</span><br><span class="line"><span class="keyword">const</span> msg = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line">  .readFileSync(msgPath, <span class="string">'utf-8'</span>)</span><br><span class="line">  .trim()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commitRE = <span class="regexp">/^(revert: )?(feat|fix|docs|style|refactor|perf|test|workflow|ci|chore|types)(\(.+\))?: .&#123;1,50&#125;/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!commitRE.test(msg)) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log()</span><br><span class="line">  <span class="built_in">console</span>.error(</span><br><span class="line">    <span class="string">`  <span class="subst">$&#123;chalk.bgRed.white(<span class="string">' ERROR '</span>)&#125;</span> <span class="subst">$&#123;chalk.red(</span></span></span><br><span class="line"><span class="string"><span class="subst">      <span class="string">`invalid commit message format.`</span></span></span></span><br><span class="line"><span class="string"><span class="subst">    )&#125;</span>\n\n`</span> +</span><br><span class="line">      chalk.red(</span><br><span class="line">        <span class="string">`  Proper commit message format is required for automated changelog generation. Examples:\n\n`</span></span><br><span class="line">      ) +</span><br><span class="line">      <span class="string">`    <span class="subst">$&#123;chalk.green(<span class="string">`feat(compiler): add 'comments' option`</span>)&#125;</span>\n`</span> +</span><br><span class="line">      <span class="string">`    <span class="subst">$&#123;chalk.green(</span></span></span><br><span class="line"><span class="string"><span class="subst">        <span class="string">`fix(v-model): handle events on blur (close #28)`</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      )&#125;</span>\n\n`</span> +</span><br><span class="line">      chalk.red(</span><br><span class="line">        <span class="string">`  You can also use <span class="subst">$&#123;chalk.cyan(</span></span></span><br><span class="line"><span class="string"><span class="subst">          <span class="string">`npm run commit`</span></span></span></span><br><span class="line"><span class="string"><span class="subst">        )&#125;</span> to interactively generate a commit message.\n`</span></span><br><span class="line">      )</span><br><span class="line">  )</span><br><span class="line">  process.exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="git-钩子"><a href="#git-钩子" class="headerlink" title="git 钩子"></a><a href="https://git-scm.com/docs/githooks" target="_blank" rel="noopener">git 钩子</a></h2><blockquote><p>在 git 执行特定的阶段触发的程序，这些程序被放置在特定的目录下<code>$GIT_DIR/hooks</code>。</p></blockquote><p>常用的钩子：</p><ul><li><p>pre-commit：执行<code>git-commit</code>时触发，但是你可以通过<code>--no-verify</code>选项绕过这个钩子。如果该钩子以非零状态码退出，那么会取消这次的提交。</p></li><li><p>commit-msg：执行<code>git-commit</code>和<code>git-merge</code>的时候触发，但是你可以通过<code>--no-verify</code>选项绕过这个钩子。执行该钩子，会将握有提案信息的文件名作为参数传给该钩子。可以使用该钩子来编辑提交信息文件以规范提交信息，也可以拒绝提交信息。</p></li><li><p>post-commit：执行这个钩子时，提交信息已经生成。主要用来发送一些通知等。</p></li><li><p>pre-push：执行<code>git-push</code>时触发，会将远程地址和分支名称传入该钩子。如果该钩子以非零状态码退出，那么退出该次推送。</p></li></ul><h2 id="husky"><a href="#husky" class="headerlink" title="husky"></a><a href="https://github.com/typicode/husky" target="_blank" rel="noopener">husky</a></h2><blockquote><p>通过<code>npm scripts</code>来触发<code>git hooks</code>，让使用<code>git hooks</code>更加的简单。</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"husky"</span>: &#123;</span><br><span class="line">    <span class="attr">"hooks"</span>: &#123;</span><br><span class="line">      <span class="attr">"pre-commit"</span>: <span class="string">"lint-staged"</span>,</span><br><span class="line">      <span class="attr">"commit-msg"</span>: <span class="string">"node verify-commit-msg.js"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="lint-staged"><a href="#lint-staged" class="headerlink" title="lint-staged"></a><a href="https://github.com/okonet/lint-staged" target="_blank" rel="noopener">lint-staged</a></h2><blockquote><p>在 git 执行的特定时期来触发校验。</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"lint-staged"</span>: &#123;</span><br><span class="line">    <span class="attr">"*.&#123;js,jsx,json&#125;"</span>: [<span class="string">"prettier --write"</span>, <span class="string">"git add"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="prettier"><a href="#prettier" class="headerlink" title="prettier"></a><a href="https://prettier.io/" target="_blank" rel="noopener">prettier</a></h2><blockquote><p>一款强大的代码格式化工具，支持<code>js</code>,<code>jsx</code>,<code>Vue</code>, <code>Flow</code>, <code>TypeScript</code>等。</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"prettier"</span>: &#123;</span><br><span class="line">    <span class="attr">"semi"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"singleQuote"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"arrowParens"</span>: <span class="string">"avoid"</span>,</span><br><span class="line">    <span class="attr">"trailingComma"</span>: <span class="string">"es5"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="prettier整合eslint"><a href="#prettier整合eslint" class="headerlink" title="prettier整合eslint"></a>prettier整合eslint</h3><p>.eslintrc.json:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"plugins"</span>: [<span class="string">"prettier"</span>],</span><br><span class="line">  <span class="attr">"extends"</span>: [<span class="string">"plugin:prettier/recommended"</span>],</span><br><span class="line">  <span class="attr">"rules"</span>: &#123;</span><br><span class="line">    <span class="attr">"prettier/prettier"</span>: <span class="string">"warn"</span></span><br><span class="line">    // other eslint rules</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="eslint"><a href="#eslint" class="headerlink" title="eslint"></a><a href="https://eslint.org/" target="_blank" rel="noopener">eslint</a></h2><h2 id="Airbnb-Javascript-Style"><a href="#Airbnb-Javascript-Style" class="headerlink" title="Airbnb Javascript Style"></a><a href="https://github.com/airbnb/javascript" target="_blank" rel="noopener">Airbnb Javascript Style</a></h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;git-日志提交规范&quot;&gt;&lt;a href=&quot;#git-日志提交规范&quot; class=&quot;headerlink&quot; title=&quot;git 日志提交规范&quot;&gt;&lt;/a&gt;git 日志提交规范&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;格式如下：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;
      
    
    </summary>
    
      <category term="工作流" scheme="https://xxxxxmiss.github.io/categories/%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    
    
      <category term="workflow" scheme="https://xxxxxmiss.github.io/tags/workflow/"/>
    
      <category term="git" scheme="https://xxxxxmiss.github.io/tags/git/"/>
    
      <category term="lint" scheme="https://xxxxxmiss.github.io/tags/lint/"/>
    
      <category term="prettier" scheme="https://xxxxxmiss.github.io/tags/prettier/"/>
    
      <category term="changelog" scheme="https://xxxxxmiss.github.io/tags/changelog/"/>
    
  </entry>
  
  <entry>
    <title>make</title>
    <link href="https://xxxxxmiss.github.io/2018/03/14/make/"/>
    <id>https://xxxxxmiss.github.io/2018/03/14/make/</id>
    <published>2018-03-14T06:42:07.000Z</published>
    <updated>2018-03-14T06:55:54.682Z</updated>
    
    <content type="html"><![CDATA[<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><ul><li>以点（.）开头并且全部是大写字母的变量，有特殊的意义。</li><li>大小写敏感。</li><li>通过<code>${var}</code>,<code>$(var)</code>来引用一个变量</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;变量&quot;&gt;&lt;a href=&quot;#变量&quot; class=&quot;headerlink&quot; title=&quot;变量&quot;&gt;&lt;/a&gt;变量&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;以点（.）开头并且全部是大写字母的变量，有特殊的意义。&lt;/li&gt;
&lt;li&gt;大小写敏感。&lt;/li&gt;
&lt;li&gt;通过&lt;code&gt;${v
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>shell-command</title>
    <link href="https://xxxxxmiss.github.io/2018/03/08/shell-command/"/>
    <id>https://xxxxxmiss.github.io/2018/03/08/shell-command/</id>
    <published>2018-03-07T16:48:17.000Z</published>
    <updated>2018-03-07T17:10:40.984Z</updated>
    
    <content type="html"><![CDATA[<h2 id="id"><a href="#id" class="headerlink" title="id"></a>id</h2><blockquote><p>查看用户属性</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 打印当前用户的uid, 用户名, gid, 组名等相关信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> id</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 打印uid</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> id -u</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 打印gid</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> id -g</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 打印用户名</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> id -un</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 打印组名</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> id -gn</span></span><br></pre></td></tr></table></figure><h2 id="amp-符号"><a href="#amp-符号" class="headerlink" title="&amp;符号"></a>&amp;符号</h2><blockquote><p><code>&amp;</code>是Bash内置的用于并行处理进程的一个控制操作符。在命令行的末尾添加<code>&amp;</code>将会在后台运行该命令，它将在当前的Shell进行下启动一个子Shell进程。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sleep 10 &amp;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出任务编号和子进程号</span></span><br><span class="line">[1] 22525</span><br></pre></td></tr></table></figure><p>通过<code>jobs</code>命令来查看后台正在运行的任务信息：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">jobs</span></span></span><br><span class="line">[1]  + running    sleep 10</span><br></pre></td></tr></table></figure></p><p>通过<code>-l</code>选项可以查看正在后台运行的任务的进程号等信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">jobs</span> -l</span></span><br><span class="line">[1]  + 22711 running    sleep 10</span><br></pre></td></tr></table></figure></p><p>通过<code>%任务编号</code>或者<code>fg 任务编号</code>可以将后台任务切换到前台：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sleep 30 &amp;</span></span><br><span class="line">[1] 22711</span><br><span class="line"><span class="meta">$</span><span class="bash"> %1</span></span><br></pre></td></tr></table></figure></p><p>通过以下几个步骤可以将任务在前后台间切换：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sleep 30 &amp;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> %1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> CTRL + Z组合键</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者使用<span class="built_in">bg</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> %1 &amp;</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;id&quot;&gt;&lt;a href=&quot;#id&quot; class=&quot;headerlink&quot; title=&quot;id&quot;&gt;&lt;/a&gt;id&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;查看用户属性&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>docker</title>
    <link href="https://xxxxxmiss.github.io/2018/03/06/docker/"/>
    <id>https://xxxxxmiss.github.io/2018/03/06/docker/</id>
    <published>2018-03-06T15:58:01.000Z</published>
    <updated>2018-11-23T09:24:01.734Z</updated>
    
    <content type="html"><![CDATA[<h2 id="docker-简介"><a href="#docker-简介" class="headerlink" title="docker 简介"></a>docker 简介</h2><blockquote><p>docker 是一个开发，运输，运行程序的一个平台。docker 将你的程序和基础设施隔离开来，以便于快速的运输，测试，开发。</p></blockquote><h2 id="docker-引擎"><a href="#docker-引擎" class="headerlink" title="docker 引擎"></a>docker 引擎</h2><blockquote><p><a href="https://docs.docker.com/engine/docker-overview/#the-docker-platform" target="_blank" rel="noopener">官方传送门</a></p></blockquote><h2 id="docker-架构（体系结构）"><a href="#docker-架构（体系结构）" class="headerlink" title="docker 架构（体系结构）"></a>docker 架构（体系结构）</h2><blockquote><p>使用<code>client-server</code>架构，docker 客户端告诉 daemon(docker 后台常驻进程)去做一个<strong>构建，运行，分发</strong>docker 容器。<br>docker 客户端和 daemon 的交流通信使用<code>rest api</code>，基于一个<code>unix socket</code>或者<code>network interface</code>之上。</p></blockquote><h3 id="几个术语（glossary）"><a href="#几个术语（glossary）" class="headerlink" title="几个术语（glossary）"></a>几个术语（glossary）</h3><ul><li><p><code>Docker registries</code>: docker 镜像源，docker 默认被配置为去<code>docker hub</code>上下载镜像。</p></li><li><p><code>images</code>: 镜像，一个镜像是带有一系列指令的只读的模板(包)，用来创建 docker 容器。当你创建自己的镜像的时候，你需要在<code>Dockerfile</code>中按照一定的简单的语法去定义一些步骤去创建镜像并运行它。<br>一个镜像包含了运行一个程序所需要的各种依赖（代码，运行时，库，环境变量，配置文件）。<br><code>Dockerfile</code>中的每一条指令都会生成一个<strong>层</strong>。</p></li><li><p><code>containers</code>: 容器，一个容器是一个镜像的可运行的实例。可以通过<code>docker api</code>或则<code>CLI</code>对实例进行<code>CRUD</code>等操作。</p></li><li><p><code>services</code>: 服务，服务允许你跨多个 daemon 扫描容器，这些 daemon 相互协作称之为一个集群（swarm）。</p></li></ul><h2 id="docker-基本开发环境搭建"><a href="#docker-基本开发环境搭建" class="headerlink" title="docker 基本开发环境搭建"></a>docker 基本开发环境搭建</h2><h3 id="容器（containers）"><a href="#容器（containers）" class="headerlink" title="容器（containers）"></a>容器（containers）</h3><ul><li>使用<code>Dockerfile</code>定义容器</li></ul><p>Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use an official Python runtime as a parent image</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">2.7</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the working directory to /app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Copy the current directory contents into the container at /app</span></span></span><br><span class="line"><span class="bash">ADD . /app</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Install any needed packages specified in requirements.txt</span></span></span><br><span class="line"><span class="bash">RUN pip install --trusted-host pypi.python.org -r requirements.txt</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Make port 80 available to the world outside this container</span></span></span><br><span class="line"><span class="bash">EXPOSE 80</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Define environment variable</span></span></span><br><span class="line"><span class="bash">ENV NAME World</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Run app.py when the container launches</span></span></span><br><span class="line"><span class="bash">CMD [<span class="string">"python"</span>, <span class="string">"app.py"</span>]</span></span><br></pre></td></tr></table></figure><p>app.py</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">from flask <span class="built_in">import</span> Flask</span><br><span class="line">from redis <span class="built_in">import</span> Redis, RedisError</span><br><span class="line"><span class="built_in">import</span> os</span><br><span class="line"><span class="built_in">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to Redis</span></span><br><span class="line"><span class="attr">redis</span> = Redis(<span class="attr">host="redis",</span> <span class="attr">db=0,</span> <span class="attr">socket_connect_timeout=2,</span> <span class="attr">socket_timeout=2)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app</span> = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">"/"</span>)</span><br><span class="line">def hello():</span><br><span class="line">    try:</span><br><span class="line">        <span class="attr">visits</span> = redis.incr(<span class="string">"counter"</span>)</span><br><span class="line">    except RedisError:</span><br><span class="line">        <span class="attr">visits</span> = <span class="string">"&lt;i&gt;cannot connect to Redis, counter disabled&lt;/i&gt;"</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">html</span> = <span class="string">"&lt;h3&gt;Hello &#123;name&#125;!&lt;/h3&gt;"</span> \</span><br><span class="line">           <span class="string">"&lt;b&gt;Hostname:&lt;/b&gt; &#123;hostname&#125;&lt;br/&gt;"</span> \</span><br><span class="line">           <span class="string">"&lt;b&gt;Visits:&lt;/b&gt; &#123;visits&#125;"</span></span><br><span class="line">    return html.format(<span class="attr">name=os.getenv("NAME",</span> <span class="string">"world"</span>), <span class="attr">hostname=socket.gethostname(),</span> <span class="attr">visits=visits)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(<span class="attr">host='0.0.0.0',</span> <span class="attr">port=80)</span></span><br></pre></td></tr></table></figure><ul><li>构建 docker 镜像</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">build </span>-t friendlyhello .</span><br></pre></td></tr></table></figure><ul><li>查看上一步构建的镜像</li></ul><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">image</span> <span class="keyword">ls</span></span><br></pre></td></tr></table></figure><ul><li>运行 app</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">run</span><span class="bash"> -p 4000:80 friendlyhello</span></span><br></pre></td></tr></table></figure><ul><li>查看 app.py 的输出<br>在浏览器访问<code>http://localhost:4000</code>或者<br>在终端使用 curl 查看：</li></ul><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> curl http:<span class="comment">//localhost:4000</span></span><br></pre></td></tr></table></figure><ul><li>查看运行中的容器</li></ul><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">container</span> <span class="keyword">ls</span></span><br></pre></td></tr></table></figure><ul><li>停止运行一个容器</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker container <span class="keyword">stop</span> <span class="symbol">&lt;IMAGE_ID&gt;</span></span><br></pre></td></tr></table></figure><h3 id="服务（services）"><a href="#服务（services）" class="headerlink" title="服务（services）"></a>服务（services）</h3><blockquote><p>一个服务只会运行一个镜像，但是它定义了镜像运行的法规：比如该使用什么端口，产生多少个容器的复制品。<br>关于服务的概念比较的抽象，可以查看<a href="https://docs.docker.com/get-started/part3/#about-services" target="_blank" rel="noopener">官方例子对于服务的解释</a></p></blockquote><p>task:</p><blockquote><p>一个 service 中运行的一个容器叫做 task。task 被给予一个自增的 id,增加到<code>replicas</code>的数量位置。<br>查看 service 中的 tasks</p><p>一个<code>docker-compose.yml</code>文件定义了 docker 容器在产品模式下应该具有的行为。</p></blockquote><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">version</span>: <span class="string">"3"</span></span><br><span class="line"><span class="attribute">services</span>:</span><br><span class="line">  <span class="attribute">web</span>:</span><br><span class="line">    # replace username/<span class="attribute">repo</span>:tag with your name and image details</span><br><span class="line">    <span class="attribute">image</span>: username/<span class="attribute">repo</span>:tag</span><br><span class="line">    <span class="attribute">deploy</span>:</span><br><span class="line">      <span class="attribute">replicas</span>: <span class="number">5</span></span><br><span class="line">      <span class="attribute">resources</span>:</span><br><span class="line">        <span class="attribute">limits</span>:</span><br><span class="line">          <span class="attribute">cpus</span>: <span class="string">"0.1"</span></span><br><span class="line">          <span class="attribute">memory</span>: <span class="number">50</span>M</span><br><span class="line">      <span class="attribute">restart_policy</span>:</span><br><span class="line">        <span class="attribute">condition</span>: on-failure</span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">"80:80"</span></span><br><span class="line">    <span class="attribute">networks</span>:</span><br><span class="line">      - webnet</span><br><span class="line"><span class="attribute">networks</span>:</span><br><span class="line">  <span class="attribute">webnet</span>:</span><br></pre></td></tr></table></figure><p>运行我们的服务：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker stack deploy -c docker-compose<span class="selector-class">.yml</span> getstartedlab</span><br></pre></td></tr></table></figure><p>在使用上面的命令来启动一个服务的时候，必须先设置一个<code>swarm manager</code>（集群 leader）, 不然会抛出一个错误提示。后面解释为什么要这样做：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>docker swarm init</span><br></pre></td></tr></table></figure><p>查看启动的服务：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker<span class="built_in"> service </span>ls</span><br><span class="line"><span class="comment"># 通过该命令查看，可以看出该服务的名称为 getstartedlab_web</span></span><br><span class="line"><span class="comment"># getstartedlab是你在上一个命令中定义的app的名称</span></span><br><span class="line"><span class="comment"># web是你在docker-compose.yaml中定义的服务名称</span></span><br></pre></td></tr></table></figure><p>列出一个服务中有多少个任务：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker<span class="built_in"> service </span>ps getstartedlab_web</span><br></pre></td></tr></table></figure><p>请求服务：</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="number">-4</span> http:<span class="comment">//localhost</span></span><br><span class="line"><span class="meta"># 或者在浏览器中打开并刷新几次，可以看到Hostname在改变</span></span><br></pre></td></tr></table></figure><p>扫描 app: 可以改变<code>docker-compose.yml</code>中的相关配置，然后重新运行发布命令</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker stack deploy -c docker-compose<span class="selector-class">.yml</span> getstartedlab</span><br></pre></td></tr></table></figure><p>拆卸 app 和 swarm</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>docker stack rm getstartedlab</span><br><span class="line"><span class="variable">$ </span>docker swarm leave --force</span><br></pre></td></tr></table></figure><h3 id="Stacks-栈"><a href="#Stacks-栈" class="headerlink" title="Stacks(栈)"></a>Stacks(栈)</h3><blockquote><p>栈是一组相互关联的服务，这些服务可以共享依赖关系,被组织和缩放。一个栈有着定义和协调整个应用的能力。</p></blockquote><h2 id="Dockerfile-常用指令（选项）"><a href="#Dockerfile-常用指令（选项）" class="headerlink" title="Dockerfile 常用指令（选项）"></a>Dockerfile 常用指令（选项）</h2><p><a href="https://docs.docker.com/engine/reference/builder/" target="_blank" rel="noopener">官方传送门</a></p><blockquote><p><code>Dockerfile</code>中的指令大小写不敏感，但是按照约定都使用大写，以便于和指定的参数区分。<br><code>Dockerfile</code>中的指令按顺序一条一条的执行，并且<code>Dockerfile</code>文件必须以<code>FROM</code>开始</p></blockquote><h3 id="构建上下文-context"><a href="#构建上下文-context" class="headerlink" title="构建上下文 context"></a>构建上下文 context</h3><blockquote><p><code>docker build</code>命令基于<code>Dockerfile</code>文件和<code>context</code>构建镜像。<br><code>context</code>是一个<code>PATH</code>或则<code>URL</code>指定的文件集合。<br><code>PATH</code>是一个本地文件系统的一个目录，<code>URL</code>是一个 git 仓库。</p></blockquote><h3 id="dockerignore"><a href="#dockerignore" class="headerlink" title=".dockerignore"></a><code>.dockerignore</code></h3><blockquote><p>为了增加构建的性能，可以将不需要的文件添加到<code>.dockerignore</code></p></blockquote><p>一般情况下，<code>Dockerfile</code>放置在<code>context</code>的根目录下，可以使用<code>-f</code>选项指定<code>Dockerfile</code>文件的位置：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">build</span> -f /<span class="keyword">path</span>/<span class="keyword">to</span>/a/Dockerfile .</span><br></pre></td></tr></table></figure><p>可以为一个镜像指定多个仓库标签:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">build </span>-t <span class="keyword">shykes/myapp:1.0.2 </span>-t <span class="keyword">shykes/myapp:latest </span>.</span><br></pre></td></tr></table></figure><h3 id="解析器指令（parser-directives）"><a href="#解析器指令（parser-directives）" class="headerlink" title="解析器指令（parser directives）"></a>解析器指令（parser directives）</h3><blockquote><p><code>Dockerfile</code>中的注释已<code>#</code>开头，但是解析器指令时一种特殊的注释，必须出现在<code>Dockerfile</code>中的开头部分。<br>语法：# directive=value</p></blockquote><h3 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h3><blockquote><p>初始化一个新的构建时期，为接下来的指令设置一个<a href="https://docs.docker.com/glossary/" target="_blank" rel="noopener">基本镜像</a>。<br>常用的 3 种形式：</p></blockquote><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> &lt;<span class="built_in">image</span>&gt; [AS &lt;<span class="built_in">name</span>&gt;]</span><br><span class="line"><span class="keyword">FROM</span> &lt;<span class="built_in">image</span>&gt;[:&lt;tag&gt;] [AS &lt;<span class="built_in">name</span>&gt;]</span><br><span class="line"><span class="keyword">FROM</span> &lt;<span class="built_in">image</span>&gt;[@&lt;digest&gt;] [AS &lt;<span class="built_in">name</span>&gt;]</span><br></pre></td></tr></table></figure><h3 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h3><blockquote><p>在当前镜像的顶部新的层里运行任何指令，并将结果提交到下一步中。<br>层运行指令并且生成提交信息符合<code>Docker</code>的核心概念：这个提交是非常便宜的，容器可以基于一个镜像的任何历史点创建。<br>2 种使用形式：shell 形式和 exec 形式</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> /bin/bash -c <span class="string">'source $HOME/.bashrc; \</span></span></span><br><span class="line"><span class="bash"><span class="built_in">echo</span> <span class="variable">$HOME</span><span class="string">'</span></span></span><br><span class="line"><span class="bash"><span class="comment"># exec形式必须使用双引号（""）</span></span></span><br><span class="line"><span class="bash">RUN [<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"echo hello"</span>]</span></span><br></pre></td></tr></table></figure><h3 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h3><blockquote><p>一个<code>Dockerfile</code>中只能出现一个<code>CMD</code>,如果出现了多个，那么只有最后一个起作用。<br>3 种使用形式：</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exec形式，最受欢迎的形式</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"executable"</span>,<span class="string">"param1"</span>,<span class="string">"param2"</span>]</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># 作为默认值传递到 entrypoint</span></span></span><br><span class="line"><span class="bash">CMD [<span class="string">"param1"</span>,<span class="string">"param2"</span>]</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># shell形式</span></span></span><br><span class="line"><span class="bash">CMD <span class="built_in">command</span> param1 param2</span></span><br></pre></td></tr></table></figure><h3 id="LABEL"><a href="#LABEL" class="headerlink" title="LABEL"></a>LABEL</h3><blockquote><p>为镜像添加一些元数据，可以使用<code>docker inspect</code>查看 label 的值。使用形式:</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LABEL <span class="tag">&lt;<span class="name">key</span>&gt;</span>=<span class="tag">&lt;<span class="name">value</span>&gt;</span> <span class="tag">&lt;<span class="name">key</span>&gt;</span>=<span class="tag">&lt;<span class="name">value</span>&gt;</span> <span class="tag">&lt;<span class="name">key</span>&gt;</span>=<span class="tag">&lt;<span class="name">value</span>&gt;</span> ...</span><br></pre></td></tr></table></figure><p>一些常用情况的例子</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LABEL</span><span class="bash"> <span class="string">"com.example.vendor"</span>=<span class="string">"ACME Incorporated"</span></span></span><br><span class="line"><span class="bash">LABEL com.example.label-with-value=<span class="string">"foo"</span></span></span><br><span class="line"><span class="bash">LABEL version=<span class="string">"1.0"</span></span></span><br><span class="line"><span class="bash">LABEL description=<span class="string">"This text illustrates \</span></span></span><br><span class="line"><span class="bash">that label-values can span multiple lines.<span class="string">"</span></span></span><br></pre></td></tr></table></figure><h3 id="MAINTAINER"><a href="#MAINTAINER" class="headerlink" title="MAINTAINER"></a><del>MAINTAINER</del></h3><blockquote><p>已过期，使用<code>LABEL</code>代替。</p></blockquote><h3 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h3><blockquote><p>指定 docker 容器在运行的时候监听那个网络端口，可以指定使用 TCP 还是 DUP。如果没有指定协议，默认使用 TCP。使用形式：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE <span class="tag">&lt;<span class="name">port</span>&gt;</span> [<span class="tag">&lt;<span class="name">port</span>&gt;</span>/<span class="tag">&lt;<span class="name">protocol</span>&gt;</span>...]</span><br></pre></td></tr></table></figure><h3 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h3><blockquote><p>可以使用<code>docker inspect</code>查看它的值，<br>可以使用<code>docker run --env &lt;key&gt;=&lt;value&gt;</code>改变值。<br>环境变量持久化可能会带来一些副作用，所以可以通过<code>RUN &lt;key&gt;=&lt;value&gt; &lt;command&gt;</code>来设置单个指令变量。<br>使用形式：</p></blockquote><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 设置单个值的形式，key后面的第一个空格后面的所有字符（包括空格，引号等）都被设置为&lt;value&gt;</span></span><br><span class="line">ENV <span class="params">&lt;key&gt;</span> <span class="params">&lt;value&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 可以设置多个值</span></span><br><span class="line">ENV <span class="params">&lt;key&gt;</span>=<span class="params">&lt;value&gt;</span> ...</span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ENV <span class="attribute">myName</span>=<span class="string">"John Doe"</span> <span class="attribute">myDog</span>=Rex\ The\ Dog \</span><br><span class="line">    <span class="attribute">myCat</span>=fluffy</span><br></pre></td></tr></table></figure><p>等价于</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> myname John Doe</span><br><span class="line"><span class="keyword">ENV</span> myDog Rex The Dog</span><br><span class="line"><span class="keyword">ENV</span> myCat fluffy</span><br></pre></td></tr></table></figure><h3 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h3><blockquote><p>该指令将<code>src</code>中的文件，文件夹或者远程文件拷贝到镜像所在的文件系统的<code>dest</code>目录。<br><code>src</code>中的路径被解析为相对于构建上下文<code>context</code>的路径，路径中可包含通配符。<br><code>dest</code>路径必须是一个绝对路径或者相对于<code>WORKDIR</code>的路径。<br>使用形式：</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">ADD</span> [<span class="attribute">--chown</span>=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;<span class="built_in">..</span>. &lt;dest&gt;</span><br><span class="line"><span class="builtin-name">ADD</span> [<span class="attribute">--chown</span>=&lt;user&gt;:&lt;group&gt;] [<span class="string">"&lt;src&gt;"</span>,<span class="built_in">..</span>. <span class="string">"&lt;dest&gt;"</span>]</span><br></pre></td></tr></table></figure><p>关于该指令的详细说明，请参看<a href="https://docs.docker.com/engine/reference/builder/#add" target="_blank" rel="noopener">官方文旦</a></p><h3 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h3><blockquote><p>该指令和<code>ADD</code>指令类似。区别是<code>ADD</code>支持<code>src</code>是一个<code>URL</code>，而<code>COPY</code>不支持。</p></blockquote><h3 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h3><blockquote><p>2 种使用形式：shell 形式和 exec 形式</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"executable"</span>, <span class="string">"param1"</span>, <span class="string">"param2"</span>] (<span class="built_in">exec</span> form, preferred)</span></span><br><span class="line"><span class="bash">ENTRYPOINT <span class="built_in">command</span> param1 param2</span></span><br></pre></td></tr></table></figure><h3 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h3><blockquote><p>用指定的名称创建一个挂载点。使用形式：</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">"/var/log/"</span>]</span></span><br><span class="line"><span class="bash">VOLUME /var/<span class="built_in">log</span> /var/db</span></span><br></pre></td></tr></table></figure><h3 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h3><blockquote><p>设置 docker 镜像跑在哪个用户或者用户 ID 下，也可以设置一个可选的组或者组 ID 下。<br>如果没有设置组，默认使用<code>root</code>组。<br>其他的指令<code>RUN, CMD, ENTRYPOINT</code>也遵守这一规则。</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">USER &lt;user&gt;[:&lt;group&gt;]</span><br><span class="line">USER &lt;UID&gt;[:&lt;GID&gt;]</span><br></pre></td></tr></table></figure><h3 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h3><blockquote><p>为<code>Dockerfile</code>中的<code>RUN, CMD, ENTRYPOINT, ADD, COPY</code>指令提供工作目录。<br><code>WORKDIR</code>可以在<code>Dockerfile</code>中出现多次，那么后面的路径时相对于前面的。</p></blockquote><p>TODO: 类似于 nodejs 中的 resolve 方法？解析到一个绝对路径为止？</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /a</span><br><span class="line">WORKDIR b</span><br><span class="line">WORKDIR c</span><br><span class="line">RUN pwd</span><br><span class="line">=&gt; /a/b/c</span><br></pre></td></tr></table></figure><blockquote><p><code>WORKDIR</code>可以使用<code>Dockerfile</code>中已经定义的环境变量。</p></blockquote><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ENV DIRPATH /path</span><br><span class="line">WORKDIR $DIRPATH/$DIRNAME</span><br><span class="line">RUN pwd</span><br><span class="line">=&gt; /path/$DIRNAME</span><br></pre></td></tr></table></figure><h2 id="compose文件结构"><a href="#compose文件结构" class="headerlink" title="compose文件结构"></a><code>compose</code>文件结构</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">    webapp:</span></span><br><span class="line">        <span class="comment"># 引用顶层的networks</span></span><br><span class="line"><span class="attr">        networks:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">some-network</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">other-network</span></span><br><span class="line"><span class="attr">        depends_on:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">db</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">        build:</span></span><br><span class="line">            <span class="comment"># 包含Dockerfile的目录或者一个git仓库</span></span><br><span class="line">            <span class="comment"># 如果是一个相对路径，那么是相对于compose file文件的路径</span></span><br><span class="line"><span class="attr">            context:</span> <span class="string">'./dir'</span></span><br><span class="line"><span class="attr">            dockerfile:</span> <span class="string">Dockerfile-alternate</span></span><br><span class="line">            <span class="comment"># 既可以是一个对象，也可以是一个数组</span></span><br><span class="line">            <span class="comment"># 该选项指定在Dockerfile ARG选项中定义的参数</span></span><br><span class="line">            <span class="comment"># 第一种使用形式</span></span><br><span class="line"><span class="attr">            args:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">buildno=1</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">password=secret</span></span><br><span class="line">            <span class="comment"># 第二种使用形式</span></span><br><span class="line"><span class="attr">            args:</span></span><br><span class="line"><span class="attr">                buildno:</span> <span class="number">1</span></span><br><span class="line">            <span class="comment"># 一个镜像列表指定docker引擎使用的缓存</span></span><br><span class="line"><span class="attr">            cache_form:</span></span><br><span class="line"><span class="attr">                - alpine:</span><span class="string">latest</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">corp/web_app:3.14</span></span><br><span class="line">            <span class="comment"># 添加元数据到结果镜像中</span></span><br><span class="line">            <span class="comment"># 第一种使用形式</span></span><br><span class="line"><span class="attr">            labels:</span></span><br><span class="line">                <span class="comment"># 推荐使用reverse-DNS命名规则，避免和其他软件使用的标签冲突</span></span><br><span class="line">                <span class="string">com.example.description:</span> <span class="string">"Accounting webapp"</span></span><br><span class="line">                <span class="string">com.example.department:</span> <span class="string">"Finance"</span></span><br><span class="line">                <span class="string">com.example.label-with-empty-value:</span> <span class="string">""</span></span><br><span class="line">            <span class="comment"># 第二种使用形式</span></span><br><span class="line"><span class="attr">            labels:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">"com.example.description=Accounting webapp"</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">"com.example.department=Finance"</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">"com.example.label-with-empty-value"</span></span><br><span class="line">            <span class="comment"># 为构建的容器设置/dev/shm设置大小</span></span><br><span class="line"><span class="attr">            shm_size:</span></span><br><span class="line"><span class="attr">                shm_size:</span> <span class="string">'2gb'</span></span><br><span class="line">                <span class="comment"># 第二种使用形式，单位为byte</span></span><br><span class="line"><span class="attr">                shm_size:</span> <span class="number">10000000</span></span><br><span class="line">            <span class="comment"># 构建在Dockerfile中指定的时期</span></span><br><span class="line"><span class="attr">            target:</span> <span class="string">prod</span></span><br><span class="line">        <span class="comment"># 为服务指定部署和运行时的相关配置</span></span><br><span class="line"><span class="attr">        deploy:</span></span><br><span class="line"><span class="attr">            update_config:</span></span><br><span class="line">                <span class="comment"># 同一时间更新容器的数量</span></span><br><span class="line"><span class="attr">                parallelism:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">                delay:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line">                <span class="comment"># 默认值stop-first，start-first</span></span><br><span class="line"><span class="attr">                order:</span> <span class="string">stop-first</span></span><br><span class="line">                <span class="comment"># 当一个更新失败的时候后续的动作</span></span><br><span class="line">                <span class="comment"># 默认值pause, continue, rollback</span></span><br><span class="line"><span class="attr">                failure_action:</span> <span class="string">continue</span></span><br><span class="line">                <span class="comment"># 配置在一个更新期间所能容忍的失败率</span></span><br><span class="line"><span class="attr">                max_failure_ratio:</span> <span class="string">'0.20'</span></span><br><span class="line">            <span class="comment"># 重启策略</span></span><br><span class="line"><span class="attr">            restart_policy:</span></span><br><span class="line">                <span class="comment"># any(默认值), none, on-failure</span></span><br><span class="line"><span class="attr">                condition:</span> <span class="string">on-failure</span></span><br><span class="line">                <span class="comment"># 重启时间间隔, 默认值0</span></span><br><span class="line"><span class="attr">                delay:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">                max_attempts:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">                window:</span> <span class="number">120</span><span class="string">s</span></span><br><span class="line">            <span class="comment"># 只为这个服务设定标签</span></span><br><span class="line"><span class="attr">            labels:</span></span><br><span class="line">                <span class="string">com.example.description:</span> <span class="string">"This label will appear on the web service"</span></span><br><span class="line">            <span class="comment"># 默认值replicated</span></span><br><span class="line"><span class="attr">            mode:</span> <span class="string">global</span></span><br><span class="line">            <span class="comment"># 如果mode被设置为replicated,那么可以通过replicas来指定容器复制数量</span></span><br><span class="line"><span class="attr">            replicas:</span> <span class="number">6</span></span><br><span class="line"><span class="attr">            placement:</span></span><br><span class="line"><span class="attr">                constraints:</span></span><br><span class="line"><span class="bullet">                  -</span> <span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span></span><br><span class="line"><span class="bullet">                  -</span> <span class="string">engine.labels.operatingsystem</span> <span class="string">==</span> <span class="string">ubuntu</span> <span class="number">14.04</span></span><br><span class="line"><span class="attr">                preferences:</span></span><br><span class="line"><span class="attr">                  - spread:</span> <span class="string">node.labels.zone</span></span><br><span class="line">            <span class="comment"># 配置资源约束</span></span><br><span class="line"><span class="attr">            resources:</span></span><br><span class="line"><span class="attr">                limits:</span></span><br><span class="line"><span class="attr">                  cpus:</span> <span class="string">'0.50'</span></span><br><span class="line"><span class="attr">                  memory:</span> <span class="number">50</span><span class="string">M</span></span><br><span class="line"><span class="attr">                reservations:</span></span><br><span class="line"><span class="attr">                  cpus:</span> <span class="string">'0.25'</span></span><br><span class="line"><span class="attr">                  memory:</span> <span class="number">20</span><span class="string">M</span></span><br><span class="line"><span class="comment"># 增加或者移除容器的能力</span></span><br><span class="line"><span class="attr">cap_add:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ALL</span></span><br><span class="line"><span class="attr">cap_drop:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">NET_ADMIN</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">SYS_ADMIN</span></span><br><span class="line"><span class="comment"># 重写默认的命令</span></span><br><span class="line"><span class="attr">command:</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">thin</span> <span class="bullet">-p</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">configs:</span></span><br><span class="line"><span class="comment"># 为容器指定一个父组</span></span><br><span class="line"><span class="attr">cgroup_parent:</span> <span class="string">m-executor-abcd</span></span><br><span class="line"><span class="comment"># 为容器指定自定义名称，docker容器名称必须唯一</span></span><br><span class="line"><span class="attr">container_name:</span> <span class="string">my-web-container</span></span><br><span class="line"><span class="comment"># 定义设备映射</span></span><br><span class="line"><span class="attr">devices:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"/dev/ttyUSB0:/dev/ttyUSB0"</span></span><br><span class="line"><span class="comment"># 自定义dns服务</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">9.9</span><span class="number">.9</span><span class="number">.9</span></span><br><span class="line"><span class="comment"># 可以是单个值</span></span><br><span class="line"><span class="attr">dns:</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"><span class="comment"># 自定义dns搜索域</span></span><br><span class="line"><span class="attr">dns_search:</span> <span class="string">example.com</span></span><br><span class="line"><span class="attr">dns_search:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">dc1.example.com</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">dc2.example.com</span></span><br><span class="line"><span class="comment"># 在容器内部临时挂载一个文件系统</span></span><br><span class="line"><span class="attr">tmpfs:</span> <span class="string">/run</span></span><br><span class="line"><span class="attr">tmpfs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/run</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/tmp</span></span><br><span class="line"><span class="comment"># 重写默认的entrypoint</span></span><br><span class="line"><span class="attr">entrypoint:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">php</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-d</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">zend_extension=/usr/local/lib/php/extensions/no-debug-non-zts-20100525/xdebug.so</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-d</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">memory_limit=-1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">vendor/bin/phpunit</span></span><br><span class="line"><span class="comment"># 增加环境变量来自一个文件</span></span><br><span class="line"><span class="attr">env_file:</span> <span class="string">.env</span></span><br><span class="line"><span class="attr">env_file:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">./common.env</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">./apps/web.env</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/opt/secrets.env</span></span><br><span class="line"><span class="string">networks</span></span><br><span class="line"><span class="string">volumes</span></span><br></pre></td></tr></table></figure><h2 id="网络（network）"><a href="#网络（network）" class="headerlink" title="网络（network）"></a>网络（network）</h2><h3 id="桥接网络（bridge-networks）"><a href="#桥接网络（bridge-networks）" class="headerlink" title="桥接网络（bridge networks）"></a>桥接网络（bridge networks）</h3><blockquote><p>一个桥接可以是一个硬件设备或者是运行在一个主机内核中的软件。</p></blockquote><p>用户自定义桥接网路的好处：</p><ol><li>提供更好的隔离和互通性。</li><li>在容器间提供自动化<code>DNS</code>解析。</li><li>随时绑定或者解绑一个容器到自定义网络。</li><li>每个用户自定义网络可以创建一个可配置的网络。</li></ol><p>创建用户自定义的网络：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker<span class="built_in"> network </span>create my-net</span><br></pre></td></tr></table></figure><p>移除一个自定义网络：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker<span class="built_in"> network </span>rm my-net</span><br></pre></td></tr></table></figure><p>如果一个容器当前正在使用这个网络，那么必须选断开：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker<span class="built_in"> network </span>disconnect my-net my-nginx</span><br></pre></td></tr></table></figure><h2 id="宗卷（Volumes）"><a href="#宗卷（Volumes）" class="headerlink" title="宗卷（Volumes）"></a>宗卷（Volumes）</h2><blockquote><p>docker 中挂载数据的 3 种方式：</p></blockquote><ul><li>bind mount：利用机器的文件系统。</li><li>volumes：在文件系统中开辟一块区域来持久化数据，专门由 docker 管理。</li><li>tmpfs： 在内存中挂载数据，并不能持久化，当容器停止，数据丢失。</li></ul><p>关于以上 3 种的数据挂载方式，具体的介绍查<a href="https://docs.docker.com/storage/#choose-the-right-type-of-mount" target="_blank" rel="noopener">看官方文档</a></p><p>最推荐的方式是使用 Volumes（实际还是视具体情况而定），此处只讲 Volumes。</p><p>创建 Volumes:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">volume</span><span class="bash"> create my-vol</span></span><br></pre></td></tr></table></figure><p>列出所有的 Volumes:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">volume</span><span class="bash"> ls</span></span><br></pre></td></tr></table></figure><h2 id="发布镜像"><a href="#发布镜像" class="headerlink" title="发布镜像"></a>发布镜像</h2><ol><li><a href="https://cloud.docker.com/" target="_blank" rel="noopener">创建 docker 仓库</a></li></ol><blockquote><p>在<code>docker cloud</code>上只能免费创建一个私有仓库，无限制多个公有仓库。</p></blockquote><ol><li>创建镜像</li></ol><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t username/<span class="keyword">tag</span> <span class="title">.</span></span><br></pre></td></tr></table></figure><ol><li>登录</li></ol><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker login</span></span><br></pre></td></tr></table></figure><ol><li>推送镜像</li></ol><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">push</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;docker-简介&quot;&gt;&lt;a href=&quot;#docker-简介&quot; class=&quot;headerlink&quot; title=&quot;docker 简介&quot;&gt;&lt;/a&gt;docker 简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;docker 是一个开发，运输，运行程序的一个平台。doc
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>DOM元素的坐标，大小相关API梳理</title>
    <link href="https://xxxxxmiss.github.io/2018/01/07/element-coordinate/"/>
    <id>https://xxxxxmiss.github.io/2018/01/07/element-coordinate/</id>
    <published>2018-01-07T14:47:43.000Z</published>
    <updated>2018-01-07T17:34:41.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="getBoundingClientRect"><a href="#getBoundingClientRect" class="headerlink" title="getBoundingClientRect()"></a>getBoundingClientRect()</h2><blockquote><p>该API返回元素的大小及其相对于视口的位置。<br>需要注意的是：不论该元素是普通的元素，还是相对定位、绝对定位，还是fixed定位，亦或被定位（相对，绝对，fixed）元素包裹的元素，返回的对象中坐标(x,y)，top,left都是相对于视口的坐标。<br>如果该元素是可以滚动或者滑动的，那么坐标会立即改变的。<br>如果需要得到文档坐标，可以<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect" target="_blank" rel="noopener">参看这里</a></p></blockquote><p>Note: 该API返回的对象包含如下几个属性，并且这些属性的值可以包含浮点数：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;   <span class="attr">top</span>: <span class="string">''</span>,</span><br><span class="line">    right: <span class="string">''</span>,</span><br><span class="line">    bottom: <span class="string">''</span></span><br><span class="line">    left: <span class="string">''</span>,</span><br><span class="line">    width: <span class="string">''</span>, <span class="comment">// 该width是content+padding+border的宽度</span></span><br><span class="line">    height: <span class="string">''</span>,</span><br><span class="line">    x: <span class="string">''</span>,</span><br><span class="line">    y: <span class="string">''</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><hr><p>以下的这些API返回的都是整数的像素值，不带单位的</p><h2 id="clientWidth"><a href="#clientWidth" class="headerlink" title="clientWidth"></a>clientWidth</h2><blockquote><p>只读属性，返回一个<code>block</code>或者<code>inline-block</code>元素的<code>content + padding</code>的像素值。<br>如果有滚动条存在，那么<code>clientWidth = content + padding - 垂直滚动条的宽度</code></p></blockquote><h2 id="clientLeft"><a href="#clientLeft" class="headerlink" title="clientLeft"></a>clientLeft</h2><blockquote><p>只读属性，返回一个<code>block</code>或者<code>inline-block</code>元素的边框的宽度（border-width）的像素值。<br>如果有滚动条存在，那么该宽度是包含滚动条在内的宽度。</p></blockquote><h2 id="scrollHeight"><a href="#scrollHeight" class="headerlink" title="scrollHeight"></a>scrollHeight</h2><blockquote><p>只读属性，包括元素的整个高度（溢出导致在视野之外的部分）<br>这个整个高度也是<code>content + padding</code>的高度，不包括<code>border</code>和<code>margin</code>的高度。</p></blockquote><h2 id="scrollTop"><a href="#scrollTop" class="headerlink" title="scrollTop"></a>scrollTop</h2><blockquote><p>读取或者设置垂直滚动条的高度</p></blockquote><h2 id="offsetHeight"><a href="#offsetHeight" class="headerlink" title="offsetHeight"></a>offsetHeight</h2><blockquote><p>该属性返回一个元素的<code>content + padding + border + 滚动条（如果有）</code>的高度，不论该元素是<code>inline</code>还是<code>block</code>类型的元素。</p></blockquote><h2 id="offsetLeft"><a href="#offsetLeft" class="headerlink" title="offsetLeft"></a>offsetLeft</h2><blockquote><p>只读属性，返回当前元素左上角相对于<code>offsetParent</code>节点的左边界偏移的像素值。<br>详细信息可<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/offsetLeft" target="_blank" rel="noopener">参看这里</a></p></blockquote><h2 id="offsetParent"><a href="#offsetParent" class="headerlink" title="offsetParent"></a>offsetParent</h2><blockquote><p>只读属性，返回一个<strong>最近的</strong>的包含该元素的定位元素。如果没有定位元素，那么<code>offsetParent</code>为<strong>最近的</strong><code>table</code>,<code>table cell</code>或者根元素<code>html</code>。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;getBoundingClientRect&quot;&gt;&lt;a href=&quot;#getBoundingClientRect&quot; class=&quot;headerlink&quot; title=&quot;getBoundingClientRect()&quot;&gt;&lt;/a&gt;getBoundingClientRect
      
    
    </summary>
    
      <category term="js" scheme="https://xxxxxmiss.github.io/categories/js/"/>
    
    
      <category term="dom" scheme="https://xxxxxmiss.github.io/tags/dom/"/>
    
  </entry>
  
  <entry>
    <title>parclejs</title>
    <link href="https://xxxxxmiss.github.io/2017/12/12/parclejs/"/>
    <id>https://xxxxxmiss.github.io/2017/12/12/parclejs/</id>
    <published>2017-12-11T16:36:15.000Z</published>
    <updated>2017-12-11T17:17:05.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="核心依赖库"><a href="#核心依赖库" class="headerlink" title="核心依赖库"></a>核心依赖库</h2><ul><li><a href="https://github.com/babel/babel/tree/master/packages/babylon" target="_blank" rel="noopener">babylon</a></li><li><a href="https://github.com/defunctzombie/node-browser-resolve" target="_blank" rel="noopener">browser-resolve</a></li><li><a href="https://github.com/webpack/node-libs-browser" target="_blank" rel="noopener">node-libs-browser</a></li><li><a href="https://github.com/pugjs/babylon-walk" target="_blank" rel="noopener">babylon-walk</a></li><li><a href="https://github.com/thejameskyle/babel-types" target="_blank" rel="noopener">babel-types</a></li><li><a href="https://github.com/rvagg/node-worker-farm" target="_blank" rel="noopener">worker-farm</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;核心依赖库&quot;&gt;&lt;a href=&quot;#核心依赖库&quot; class=&quot;headerlink&quot; title=&quot;核心依赖库&quot;&gt;&lt;/a&gt;核心依赖库&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/babel/babel/tree/master/
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>vue-ssr</title>
    <link href="https://xxxxxmiss.github.io/2017/12/04/vue-ssr/"/>
    <id>https://xxxxxmiss.github.io/2017/12/04/vue-ssr/</id>
    <published>2017-12-04T07:20:00.000Z</published>
    <updated>2017-12-25T03:57:05.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="整合jsx"><a href="#整合jsx" class="headerlink" title="整合jsx"></a>整合jsx</h2><h3 id="依赖包"><a href="#依赖包" class="headerlink" title="依赖包"></a>依赖包</h3><ul><li>babel-plugin-syntax-jsx</li><li>babel-plugin-transform-runtime</li><li>babel-plugin-transform-vue-jsx</li></ul><h3 id="nuxt-config-js"><a href="#nuxt-config-js" class="headerlink" title="nuxt.config.js"></a>nuxt.config.js</h3><blockquote><p>在<code>build</code>配置项中增加如下配置</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">build: &#123;</span><br><span class="line">    babel: &#123;</span><br><span class="line">      <span class="string">"presets"</span>: [</span><br><span class="line">        [<span class="string">"env"</span>, &#123;</span><br><span class="line">          <span class="string">"modules"</span>: <span class="literal">false</span></span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="string">"stage-2"</span>, <span class="comment">// 为了使用对象的延展语法</span></span><br><span class="line">        <span class="string">"flow"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"plugins"</span>: [<span class="string">"transform-runtime"</span>, <span class="string">"transform-vue-jsx"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="如果只是使用客户端渲染，在-eslintrc中配置"><a href="#如果只是使用客户端渲染，在-eslintrc中配置" class="headerlink" title="如果只是使用客户端渲染，在.eslintrc中配置"></a>如果只是使用客户端渲染，在.eslintrc中配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    [<span class="string">"env"</span>, &#123;</span><br><span class="line">      <span class="attr">"modules"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="string">"stage-2"</span>, // 为了使用对象的延展语法</span><br><span class="line">    <span class="string">"flow"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"plugins"</span>: [<span class="string">"transform-runtime"</span>, <span class="string">"transform-vue-jsx"</span>]  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="整合flow"><a href="#整合flow" class="headerlink" title="整合flow"></a>整合flow</h2><h3 id="依赖包-1"><a href="#依赖包-1" class="headerlink" title="依赖包"></a>依赖包</h3><ul><li>babel-preset-flow</li><li>eslint-plugin-flowtype</li></ul><h3 id="eslintrc-js配置"><a href="#eslintrc-js配置" class="headerlink" title=".eslintrc.js配置"></a>.eslintrc.js配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line">  <span class="string">'html'</span>,</span><br><span class="line">  <span class="string">'flowtype'</span></span><br><span class="line">],</span><br><span class="line"><span class="string">'extends'</span>: [</span><br><span class="line">    <span class="string">'standard'</span>,</span><br><span class="line">    <span class="string">'plugin:flowtype/recommended'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="flow配置文件"><a href="#flow配置文件" class="headerlink" title="flow配置文件"></a>flow配置文件</h3><blockquote><p>在项目的根目录下增加<code>.flowconfig</code>配置文件，具体配置也可以查看flow的官方文档。<br><a href="https://flow.org/en/docs/install/" target="_blank" rel="noopener">flow</a></p></blockquote><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ignore</span>]</span><br><span class="line">.*/node_modules/.*</span><br><span class="line">.*/dist/.*</span><br><span class="line">.*/<span class="keyword">public</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">include</span>]</span><br><span class="line"></span><br><span class="line">[<span class="meta">libs</span>]</span><br><span class="line">flow</span><br><span class="line"></span><br><span class="line">[<span class="meta">options</span>]</span><br><span class="line"><span class="keyword">unsafe</span>.enable_getters_and_setters=<span class="literal">true</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;整合jsx&quot;&gt;&lt;a href=&quot;#整合jsx&quot; class=&quot;headerlink&quot; title=&quot;整合jsx&quot;&gt;&lt;/a&gt;整合jsx&lt;/h2&gt;&lt;h3 id=&quot;依赖包&quot;&gt;&lt;a href=&quot;#依赖包&quot; class=&quot;headerlink&quot; title=&quot;依赖包&quot;&gt;&lt;/
      
    
    </summary>
    
      <category term="构建工具" scheme="https://xxxxxmiss.github.io/categories/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="vue" scheme="https://xxxxxmiss.github.io/tags/vue/"/>
    
      <category term="ssr" scheme="https://xxxxxmiss.github.io/tags/ssr/"/>
    
  </entry>
  
</feed>
